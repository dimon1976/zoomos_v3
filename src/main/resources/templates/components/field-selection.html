<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Компонент для выбора полей сущностей при импорте/экспорте -->
<div th:fragment="fieldSelection(clientId, mode)" class="field-selection-component">
    <!-- Скрытые поля для хранения информации о текущем выборе -->
    <input type="hidden" id="selectedEntityType" name="entityType" value="product">
    <input type="hidden" id="selectedMappingId" name="mappingId" value="">
    <input type="hidden" id="isComposite" name="composite" value="true">

    <!-- Выбор типа сущности (главная) -->
    <div class="mb-4">
        <h5 th:text="${mode == 'import' ? 'Выберите тип данных для импорта' : 'Выберите тип данных для экспорта'}">
            Выберите тип данных
        </h5>
        <div class="row row-cols-1 row-cols-md-3 g-4 mt-2">
            <div class="col">
                <div class="card entity-type-card selected" data-entity-type="product">
                    <div class="card-body text-center">
                        <i class="fas fa-box fa-3x mb-3 text-primary"></i>
                        <h5 class="card-title">Товары</h5>
                        <p class="card-text small">Информация о товарах</p>
                        <input type="radio" name="entityTypeRadioBtn" value="product" class="d-none" checked>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card entity-type-card" data-entity-type="region">
                    <div class="card-body text-center">
                        <i class="fas fa-map-marker-alt fa-3x mb-3 text-success"></i>
                        <h5 class="card-title">Регионы</h5>
                        <p class="card-text small">Данные о регионах и адресах</p>
                        <input type="radio" name="entityTypeRadio" value="region" class="d-none">
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card entity-type-card" data-entity-type="competitor">
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie fa-3x mb-3 text-warning"></i>
                        <h5 class="card-title">Конкуренты</h5>
                        <p class="card-text small">Данные о конкурентах и ценах</p>
                        <input type="radio" name="entityTypeRadio" value="competitor" class="d-none">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Выбор сопоставления полей -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>Сопоставление полей</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="useComposite" checked>
                <label class="form-check-label" for="useComposite">Составные сущности</label>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="mappingSelect" class="form-label">Выберите сопоставление полей</label>
                    <select class="form-select" id="mappingSelect">
                        <option value="" selected>Автоматическое сопоставление</option>
                        <!-- Опции будут добавлены динамически -->
                    </select>
                </div>

                <div class="mb-3">
                    <button type="button" id="createMappingBtn" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>Создать новое сопоставление
                    </button>
                    <button type="button" id="viewMappingBtn" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-eye me-1"></i>Просмотреть текущее сопоставление
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Выбор полей для экспорта (отображается только в режиме экспорта) -->
    <div th:if="${mode == 'export'}" class="mb-4" id="exportFieldsContainer">
        <h5>Выберите поля для экспорта</h5>
        <div class="card">
            <div class="card-body">
                <div class="accordion" id="fieldsAccordion">
                    <!-- Секция полей товара -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingProduct">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseProduct" aria-expanded="true"
                                    aria-controls="collapseProduct">
                                Поля товара
                            </button>
                        </h2>
                        <div id="collapseProduct" class="accordion-collapse collapse show"
                             aria-labelledby="headingProduct" data-bs-parent="#fieldsAccordion">
                            <div class="accordion-body" id="productFields">
                                <!-- Поля будут добавлены динамически -->
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция полей региона -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingRegion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseRegion" aria-expanded="false"
                                    aria-controls="collapseRegion">
                                Поля региона
                            </button>
                        </h2>
                        <div id="collapseRegion" class="accordion-collapse collapse"
                             aria-labelledby="headingRegion" data-bs-parent="#fieldsAccordion">
                            <div class="accordion-body" id="regionFields">
                                <!-- Поля будут добавлены динамически -->
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция полей конкурента -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCompetitor">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseCompetitor" aria-expanded="false"
                                    aria-controls="collapseCompetitor">
                                Поля конкурента
                            </button>
                        </h2>
                        <div id="collapseCompetitor" class="accordion-collapse collapse"
                             aria-labelledby="headingCompetitor" data-bs-parent="#fieldsAccordion">
                            <div class="accordion-body" id="competitorFields">
                                <!-- Поля будут добавлены динамически -->
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="button" id="selectAllFields" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-check-square me-1"></i>Выбрать все
                    </button>
                    <button type="button" id="deselectAllFields" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-square me-1"></i>Снять все
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания нового маппинга -->
    <div class="modal fade" id="createMappingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создание нового сопоставления полей</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createMappingForm">
                        <div class="mb-3">
                            <label for="mappingName" class="form-label">Название сопоставления</label>
                            <input type="text" class="form-control" id="mappingName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="mappingDescription" class="form-label">Описание</label>
                            <textarea class="form-control" id="mappingDescription" name="description"
                                      rows="2"></textarea>
                        </div>

                        <input type="hidden" name="clientId" th:value="${clientId}">
                        <input type="hidden" name="entityType" id="mappingEntityType" value="product">
                        <input type="hidden" name="composite" id="mappingComposite" value="true">

                        <div class="mb-3">
                            <label class="form-label">Сопоставление полей</label>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                    <tr>
                                        <th>Заголовок в файле</th>
                                        <th>Поле сущности</th>
                                    </tr>
                                    </thead>
                                    <tbody id="mappingTableBody">
                                    <!-- Строки будут добавлены динамически -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveMappingBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра текущего маппинга -->
    <div class="modal fade" id="viewMappingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Текущее сопоставление полей</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="currentMappingInfo">
                        <p>Название: <span id="currentMappingName">-</span></p>
                        <p>Описание: <span id="currentMappingDescription">-</span></p>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Заголовок в файле</th>
                                <th>Поле сущности</th>
                            </tr>
                            </thead>
                            <tbody id="viewMappingTableBody">
                            <!-- Строки будут добавлены динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript для работы с выбором полей -->
    <script th:inline="javascript">
        // Получаем ID клиента из Thymeleaf
        const clientId = [[${clientId}]];
        const mode = [[${mode}]];

        // Состояние компонента
        let currentEntityType = 'product';
        let isComposite = true;
        let availableMappings = [];
        let currentMapping = null;
        let fieldsMetadata = null;

        document.addEventListener('DOMContentLoaded', function () {
            // Инициализация обработчика события после анализа файла
            document.addEventListener('fileAnalyzed', function (event) {
                if (event.detail && event.detail.headers) {
                    window.fileHeaders = event.detail.headers;
                }
                if (event.detail && event.detail.metadata) {
                    window.fieldsMetadata = event.detail.metadata;
                }
            });
            // Инициализация обработчиков событий
            initEntityTypeSelection();
            initCompositeToggle();
            initMappingSelection();
            initCreateMappingModal();

            if (mode === 'export') {
                initExportFieldsSelection();
            }

            // Загрузка полей и маппингов
            loadAvailableMappings();
            if (mode === 'export') {
                loadFieldsMetadata();
            }
        });

        // Инициализация выбора типа сущности
        function initEntityTypeSelection() {
            const entityCards = document.querySelectorAll('.entity-type-card');
            entityCards.forEach(card => {
                card.addEventListener('click', function () {
                    // Снимаем выделение со всех карточек
                    entityCards.forEach(c => c.classList.remove('selected'));

                    // Выделяем текущую карточку
                    this.classList.add('selected');

                    // Устанавливаем соответствующий radio и сохраняем тип сущности
                    currentEntityType = this.dataset.entityType;
                    document.getElementById('selectedEntityType').value = currentEntityType;
                    document.getElementById('mappingEntityType').value = currentEntityType;

                    // Обновляем доступные маппинги
                    loadAvailableMappings();

                    // Обновляем поля для экспорта
                    if (mode === 'export') {
                        loadFieldsMetadata();
                    }
                });
            });
        }

        // Инициализация переключателя составных сущностей
        function initCompositeToggle() {
            const compositeToggle = document.getElementById('useComposite');
            compositeToggle.addEventListener('change', function () {
                isComposite = this.checked;
                document.getElementById('isComposite').value = isComposite;
                document.getElementById('mappingComposite').value = isComposite;

                // Обновляем доступные маппинги
                loadAvailableMappings();

                // Обновляем поля для экспорта
                if (mode === 'export') {
                    loadFieldsMetadata();
                }
            });
        }

        // Инициализация выбора маппинга
        function initMappingSelection() {
            const mappingSelect = document.getElementById('mappingSelect');
            mappingSelect.addEventListener('change', function () {
                const mappingId = this.value;
                document.getElementById('selectedMappingId').value = mappingId;

                // Загружаем детали маппинга для просмотра
                if (mappingId) {
                    const selectedMapping = availableMappings.find(m => m.id === parseInt(mappingId));
                    currentMapping = selectedMapping;

                    // Активируем кнопку просмотра
                    document.getElementById('viewMappingBtn').disabled = false;
                } else {
                    currentMapping = null;
                    // Деактивируем кнопку просмотра
                    document.getElementById('viewMappingBtn').disabled = true;
                }
            });

            // Обработчик для кнопки просмотра маппинга
            document.getElementById('viewMappingBtn').addEventListener('click', function () {
                if (currentMapping) {
                    showCurrentMapping();
                }
            });
        }

        // Инициализация модального окна создания маппинга
        function initCreateMappingModal() {
            document.getElementById('createMappingBtn').addEventListener('click', function () {
                prepareCreateMappingModal();
                const modal = new bootstrap.Modal(document.getElementById('createMappingModal'));
                modal.show();
            });

            document.getElementById('saveMappingBtn').addEventListener('click', function () {
                saveNewMapping();
            });
        }

        // Инициализация выбора полей для экспорта
        function initExportFieldsSelection() {
            document.getElementById('selectAllFields').addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('input[name="fields[]"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            document.getElementById('deselectAllFields').addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('input[name="fields[]"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        }

        // Загрузка доступных маппингов
        function loadAvailableMappings() {
            fetch(`/api/fields/mappings?clientId=${clientId}&entityType=${currentEntityType}&composite=${isComposite}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Ошибка при загрузке маппингов:', data.error);
                        return;
                    }

                    availableMappings = data.mappings || [];
                    updateMappingSelect();
                })
                .catch(error => {
                    console.error('Ошибка при загрузке маппингов:', error);
                });
        }

        // Обновление селектора маппингов
        function updateMappingSelect() {
            const mappingSelect = document.getElementById('mappingSelect');

            // Очищаем текущие опции
            mappingSelect.innerHTML = '<option value="">Автоматическое сопоставление</option>';

            // Добавляем доступные маппинги
            availableMappings.forEach(mapping => {
                const option = document.createElement('option');
                option.value = mapping.id;
                option.textContent = mapping.name + (mapping.composite ? ' (составной)' : '');
                mappingSelect.appendChild(option);
            });

            // Деактивируем кнопку просмотра
            document.getElementById('viewMappingBtn').disabled = true;

            // Сбрасываем текущий маппинг
            currentMapping = null;
            document.getElementById('selectedMappingId').value = '';
        }

        // Загрузка метаданных полей
        function loadFieldsMetadata() {
            const endpoint = isComposite
                ? `/api/fields/composite/${currentEntityType}`
                : `/api/fields/entity/${currentEntityType}`;

            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Ошибка при загрузке метаданных полей:', data.error);
                        return;
                    }

                    fieldsMetadata = data;
                    updateFieldsSelection();
                })
                .catch(error => {
                    console.error('Ошибка при загрузке метаданных полей:', error);
                });
        }

        // Обновление выбора полей для экспорта
        function updateFieldsSelection() {
            if (!fieldsMetadata || mode !== 'export') {
                return;
            }

            // Очищаем текущие поля
            document.getElementById('productFields').innerHTML = '';
            document.getElementById('regionFields').innerHTML = '';
            document.getElementById('competitorFields').innerHTML = '';

            if (isComposite) {
                // Обновляем поля для составной сущности
                const entities = fieldsMetadata.entities || [];

                entities.forEach(entity => {
                    const entityType = entity.type;
                    const fields = entity.fields || [];
                    const containerId = entityType + 'Fields';

                    const container = document.getElementById(containerId);
                    if (container) {
                        fields.forEach(field => {
                            addFieldCheckbox(container, field);
                        });
                    }
                });
            } else {
                // Обновляем поля для одной сущности
                const fields = fieldsMetadata.fields || {};
                const containerId = currentEntityType + 'Fields';
                const container = document.getElementById(containerId);

                if (container) {
                    Object.values(fields).forEach(field => {
                        addFieldCheckbox(container, {
                            name: field.name,
                            displayName: field.displayName
                        });
                    });
                }
            }
        }

        // Добавление чекбокса для поля
        function addFieldCheckbox(container, field) {
            const div = document.createElement('div');
            div.className = 'form-check';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.id = 'field_' + field.name.replace('.', '_');
            input.name = 'fields[]';
            input.value = field.name;
            input.checked = true; // По умолчанию выбрано

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = input.id;
            label.textContent = field.displayName || field.name;

            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        }

        // Подготовка модального окна создания маппинга
        function prepareCreateMappingModal() {
            // Очищаем форму
            document.getElementById('mappingName').value = '';
            document.getElementById('mappingDescription').value = '';
            document.getElementById('mappingTableBody').innerHTML = '';

            // Проверяем наличие заголовков
            const headers = window.fileHeaders || [];
            if (headers.length === 0) {
                const tableBody = document.getElementById('mappingTableBody');
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Загрузите и проанализируйте файл для автоматического заполнения заголовков</td></tr>';
                addMappingRow();
                return;
            }

            // Если метаданные уже загружены, используем их
            if (window.fieldsMetadata) {
                addMappingFieldsFromHeaders(headers);
            } else {
                // Показываем индикатор загрузки
                const tableBody = document.getElementById('mappingTableBody');
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка метаданных...</span></div></td></tr>';

                // Получаем текущие настройки
                const entityType = document.getElementById('selectedEntityType').value;
                const isComposite = document.getElementById('useComposite').checked;

                // Загружаем метаданные полей
                const endpoint = isComposite
                    ? `/api/fields/composite/${entityType}`
                    : `/api/fields/entity/${entityType}`;

                fetch(endpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        window.fieldsMetadata = data;
                        addMappingFieldsFromHeaders(headers);
                    })
                    .catch(error => {
                        console.error('Ошибка при загрузке метаданных полей:', error);
                        tableBody.innerHTML = '<tr><td colspan="2" class="text-center text-danger"><i class="fas fa-exclamation-circle me-2"></i>Ошибка загрузки полей</td></tr>';

                        // Все равно добавляем поля для заголовков
                        setTimeout(() => addMappingFieldsFromHeaders(headers), 1000);
                    });
            }
        }

        // Добавление полей для маппинга из заголовков файла
        function addMappingFieldsFromHeaders(headers) {
            const tableBody = document.getElementById('mappingTableBody');
            tableBody.innerHTML = '';

            headers.forEach((header, index) => {
                const row = document.createElement('tr');

                // Ячейка с заголовком из файла
                const headerCell = document.createElement('td');
                const headerInput = document.createElement('input');
                headerInput.type = 'text';
                headerInput.className = 'form-control';
                headerInput.name = 'headerName' + index;
                headerInput.value = header;
                headerCell.appendChild(headerInput);

                // Ячейка с селектором поля сущности
                const fieldCell = document.createElement('td');
                const fieldSelect = document.createElement('select');
                fieldSelect.className = 'form-select';
                fieldSelect.name = 'mapping.' + header;

                // Добавляем пустую опцию
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Не выбрано --';
                fieldSelect.appendChild(emptyOption);

                // Добавляем опции полей на основе метаданных
                populateFieldOptions(fieldSelect);

                // Устанавливаем автоматически подходящее поле
                const suggestedField = suggestFieldForHeader(header);
                if (suggestedField) {
                    fieldSelect.value = suggestedField;
                }

                fieldCell.appendChild(fieldSelect);

                row.appendChild(headerCell);
                row.appendChild(fieldCell);
                tableBody.appendChild(row);
            });

            // Добавляем кнопку для добавления нового поля
            const addRowBtn = document.createElement('button');
            addRowBtn.type = 'button';
            addRowBtn.className = 'btn btn-sm btn-outline-primary mt-2';
            addRowBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Добавить поле';
            addRowBtn.onclick = addMappingRow;

            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 2;
            cell.className = 'text-center';
            cell.appendChild(addRowBtn);
            row.appendChild(cell);
            tableBody.appendChild(row);
        }

        // Заполнение селектора полей на основе метаданных
        function populateFieldOptions(fieldSelect) {
            const isComposite = document.getElementById('useComposite').checked;
            const fieldsMetadata = window.fieldsMetadata;

            // Добавим очистку содержимого после пустой опции
            while (fieldSelect.options.length > 1) {
                fieldSelect.remove(1);
            }

            // Проверяем наличие метаданных
            if (!fieldsMetadata) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Метаданные не загружены";
                fieldSelect.appendChild(option);
                return;
            }

            try {
                // Проверяем структуру метаданных
                if (fieldsMetadata.fields && fieldsMetadata.fields.allFields) {
                    const allFields = fieldsMetadata.fields.allFields;

                    // Добавляем все поля в селектор
                    allFields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field.name;
                        option.textContent = field.displayName || field.name;
                        fieldSelect.appendChild(option);
                    });
                } else if (fieldsMetadata.entities) {
                    // Альтернативная структура для составных сущностей
                    fieldsMetadata.entities.forEach(entity => {
                        if (entity.fields && entity.fields.length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = entity.displayName || entity.type;

                            entity.fields.forEach(field => {
                                const option = document.createElement('option');
                                option.value = field.name;
                                option.textContent = field.displayName || field.name;
                                optgroup.appendChild(option);
                            });

                            fieldSelect.appendChild(optgroup);
                        }
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Неизвестный формат данных";
                    fieldSelect.appendChild(option);
                }
            } catch (error) {
                console.error("Ошибка при обработке метаданных полей:", error);
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Ошибка обработки полей";
                fieldSelect.appendChild(option);
            }
        }

        // Добавление строки маппинга
        function addMappingRow() {
            const tableBody = document.getElementById('mappingTableBody');
            const rowCount = tableBody.querySelectorAll('tr').length - 1; // Исключаем строку с кнопкой

            const row = document.createElement('tr');

            const headerCell = document.createElement('td');
            const headerInput = document.createElement('input');
            headerInput.type = 'text';
            headerInput.className = 'form-control';
            headerInput.name = 'headerName' + rowCount;
            headerInput.placeholder = 'Введите заголовок';
            headerCell.appendChild(headerInput);

            const fieldCell = document.createElement('td');
            const fieldSelect = document.createElement('select');
            fieldSelect.className = 'form-select';
            fieldSelect.name = 'mapping.';

            // Обновляем name поля при изменении заголовка
            headerInput.addEventListener('change', function () {
                fieldSelect.name = 'mapping.' + this.value;
            });

            // Добавляем пустую опцию
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Не выбрано --';
            fieldSelect.appendChild(emptyOption);

            // Добавляем опции полей из метаданных
            populateFieldOptions(fieldSelect);

            fieldCell.appendChild(fieldSelect);

            row.appendChild(headerCell);
            row.appendChild(fieldCell);

            // Вставляем перед строкой с кнопкой или добавляем в конец
            const lastRow = tableBody.lastElementChild;
            if (lastRow && lastRow.querySelector('button')) {
                tableBody.insertBefore(row, lastRow);
            } else {
                tableBody.appendChild(row);
            }
        }

        // Предложение поля для заголовка
        function suggestFieldForHeader(header) {
            if (!fieldsMetadata) {
                return null;
            }

            const headerLower = header.toLowerCase();

            // Функция для проверки соответствия
            const matchField = (field) => {
                if (!field.displayName) return false;

                const displayNameLower = field.displayName.toLowerCase();
                return displayNameLower === headerLower ||
                    displayNameLower.includes(headerLower) ||
                    headerLower.includes(displayNameLower);
            };

            if (isComposite) {
                const entities = fieldsMetadata.entities || [];
                for (const entity of entities) {
                    const fields = entity.fields || [];
                    const matchedField = fields.find(matchField);
                    if (matchedField) {
                        return matchedField.name;
                    }
                }
            } else {
                const fields = fieldsMetadata.fields || {};
                const matchedField = Object.values(fields).find(matchField);
                if (matchedField) {
                    return matchedField.name;
                }
            }

            return null;
        }

        // Сохранение нового маппинга
        function saveNewMapping() {
            console.log("Вызвана функция saveNewMapping");

            try {
                // Проверяем обязательные поля
                const mappingName = document.getElementById('mappingName').value;
                if (!mappingName) {
                    alert('Пожалуйста, введите название сопоставления');
                    return;
                }

                const clientId = document.querySelector('input[name="clientId"]').value;
                const entityType = document.getElementById('mappingEntityType').value;
                const isComposite = document.getElementById('useComposite').checked;
                const description = document.getElementById('mappingDescription').value || '';

                console.log("Базовые данные:", { mappingName, clientId, entityType, isComposite });

                // Собираем данные маппинга полей из таблицы
                const rows = document.getElementById('mappingTableBody').querySelectorAll('tr');
                console.log("Найдено строк:", rows.length);

                // Создаем FormData для отправки
                const formData = new FormData();
                formData.append('name', mappingName);
                formData.append('description', description);
                formData.append('clientId', clientId);
                formData.append('entityType', entityType);
                formData.append('composite', isComposite);

                // Добавляем маппинги полей
                let mappingCounter = 0;
                rows.forEach((row, index) => {
                    // Пропускаем последнюю строку с кнопкой добавления
                    if (row.querySelector('button')) {
                        console.log(`Строка ${index}: содержит кнопку, пропускаем`);
                        return;
                    }

                    const headerInput = row.querySelector('input[type="text"]');
                    const fieldSelect = row.querySelector('select');

                    if (headerInput && fieldSelect && headerInput.value && fieldSelect.value) {
                        const key = 'mapping.' + headerInput.value;
                        const value = fieldSelect.value;
                        console.log(`Добавляем маппинг: ${key} = ${value}`);
                        formData.append(key, value);
                        mappingCounter++;
                    } else {
                        console.log(`Строка ${index}: пропускаем неполное сопоставление`);
                    }
                });

                console.log(`Всего добавлено ${mappingCounter} маппингов`);

                if (mappingCounter === 0) {
                    alert('Необходимо выбрать хотя бы одно сопоставление полей');
                    return;
                }

                // Добавляем связанные сущности
                const relatedEntities = [];
                if (isComposite) {
                    if (entityType === 'product') {
                        relatedEntities.push('region', 'competitor');
                    } else if (entityType === 'region') {
                        relatedEntities.push('product');
                    } else if (entityType === 'competitor') {
                        relatedEntities.push('product');
                    }
                }

                relatedEntities.forEach(entity => {
                    console.log(`Добавляем связанную сущность: ${entity}`);
                    formData.append('relatedEntities', entity);
                });

                // Выводим все данные для отправки
                console.log("Данные формы для отправки:");
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                // Отправляем запрос
                console.log("Отправка запроса на сервер...");
                fetch('/api/fields/mappings', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        console.log("Получен ответ от сервера:", response.status, response.statusText);
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Ошибка ${response.status}: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Успешный ответ:", data);
                        alert('Маппинг успешно создан!');

                        // Закрываем модальное окно
                        const modalEl = document.getElementById('createMappingModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        // Обновляем список маппингов
                        loadAvailableMappings();
                    })
                    .catch(error => {
                        console.error("Ошибка при выполнении запроса:", error);
                        alert(`Ошибка: ${error.message}`);
                    });

            } catch (e) {
                console.error("Ошибка в функции saveNewMapping:", e);
                alert(`Произошла ошибка: ${e.message}`);
            }
        }

        // Показ текущего маппинга
        function showCurrentMapping() {
            if (!currentMapping) {
                console.error("Маппинг не выбран");
                return;
            }

            // Заполняем основную информацию о маппинге
            document.getElementById('currentMappingName').textContent = currentMapping.name || '-';
            document.getElementById('currentMappingDescription').textContent = currentMapping.description || '-';

            // Очищаем таблицу просмотра
            const tableBody = document.getElementById('viewMappingTableBody');
            tableBody.innerHTML = '';

            // Добавляем сообщение об ограниченной функциональности
            const infoRow = document.createElement('tr');
            const infoCell = document.createElement('td');
            infoCell.colSpan = 2;
            infoCell.className = 'text-center text-info';
            infoCell.innerHTML = '<i class="fas fa-info-circle me-2"></i>Подробный просмотр деталей маппинга будет доступен в следующих версиях';
            infoRow.appendChild(infoCell);
            tableBody.appendChild(infoRow);

            // Добавляем базовую информацию о маппинге
            const rows = [
                { header: 'ID', value: currentMapping.id },
                { header: 'Тип сущности', value: currentMapping.entityType },
                { header: 'Составной', value: currentMapping.composite ? 'Да' : 'Нет' }
            ];

            rows.forEach(rowData => {
                const row = document.createElement('tr');

                const headerCell = document.createElement('td');
                headerCell.className = 'fw-bold';
                headerCell.textContent = rowData.header;

                const valueCell = document.createElement('td');
                valueCell.textContent = rowData.value;

                row.appendChild(headerCell);
                row.appendChild(valueCell);
                tableBody.appendChild(row);
            });

            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('viewMappingModal'));
            modal.show();
        }

        // Обновление таблицы просмотра маппинга
        function updateViewMappingTable(details) {
            const tableBody = document.getElementById('viewMappingTableBody');
            tableBody.innerHTML = '';

            details.forEach(detail => {
                const row = document.createElement('tr');

                const sourceCell = document.createElement('td');
                sourceCell.textContent = detail.sourceField;

                const targetCell = document.createElement('td');
                targetCell.textContent = detail.targetField;

                row.appendChild(sourceCell);
                row.appendChild(targetCell);
                tableBody.appendChild(row);
            });

            // Если нет деталей, показываем сообщение
            if (details.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.className = 'text-center text-muted';
                cell.textContent = 'Нет данных о сопоставлении полей';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }
    </script>
</div>
</html>