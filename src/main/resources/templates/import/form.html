<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Импорт данных - Обработка файлов',
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name + ' - Импорт данных'},
        ~{::.page-actions}
      )}">
<head>
    <title>Импорт данных - Обработка файлов</title>
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s;
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f1f8ff;
        }

        .upload-area.dragging {
            border-color: #0d6efd;
            background-color: #e8f0fe;
        }

        .upload-icon {
            font-size: 48px;
            color: #0d6efd;
            margin-bottom: 20px;
        }

        .entity-type-card {
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
        }

        .entity-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .entity-type-card.selected {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }

        .progress-container {
            margin-top: 20px;
        }

        #filePreview {
            display: none;
            margin-top: 20px;
        }

        .preview-table {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary me-2">
        <i class="fas fa-arrow-left me-1"></i>К клиенту
    </a>
    <a th:href="@{/clients/{id}/operations(id=${client.id})}" class="btn btn-primary me-2">
        <i class="fas fa-history me-1"></i>Операции
    </a>
    <a th:href="@{/clients/{id}/export(id=${client.id})}" class="btn btn-success">
        <i class="fas fa-file-export me-1"></i>Экспорт
    </a>
</div>

<section>
    <!-- Информация о клиенте -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Импорт данных для клиента</h5>
        </div>
        <div class="card-body">
            <p>Загрузите файл CSV или Excel для импорта данных в систему.</p>

            <form id="importForm" th:action="@{/clients/{id}/import(id=${client.id})}" method="post"
                  enctype="multipart/form-data">
                <!-- Загрузка файла -->
                <div class="mb-4">
                    <h5>1. Загрузите файл</h5>
                    <div class="upload-area mt-2" id="dropArea">
                        <input type="file" name="file" id="fileInput" accept=".csv,.xlsx,.xls" class="d-none" required>
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>Перетащите файл сюда или кликните для выбора</h5>
                        <p class="text-muted">Поддерживаемые форматы: CSV, Excel (.xlsx, .xls)</p>
                    </div>

                    <!-- Предпросмотр файла -->
                    <div id="filePreview" class="card mt-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Предпросмотр файла</h5>
                                <button type="button" id="removeFile" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-times me-1"></i>Удалить
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Имя файла:</strong> <span id="fileName"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Размер:</strong> <span id="fileSize"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Тип:</strong> <span id="fileType"></span>
                            </div>
                            <div class="mb-3">
                                <h6>Обнаруженные столбцы:</h6>
                                <div class="preview-table">
                                    <table class="table table-sm table-bordered" id="previewTable">
                                        <thead>
                                        <tr id="headerRow"></tr>
                                        </thead>
                                        <tbody id="previewBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Включение компонента выбора полей -->
                <div th:replace="~{components/field-selection :: fieldSelection(${client.id}, 'import')}"></div>

                <!-- Параметры импорта -->
                <div id="importOptions" class="mb-4">
                    <h5>2. Настройте параметры импорта</h5>
                    <div class="card mt-2">
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="importParamsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                                            data-bs-target="#basic" type="button" role="tab"
                                            aria-controls="basic" aria-selected="true">Основные</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="structure-tab" data-bs-toggle="tab"
                                            data-bs-target="#structure" type="button" role="tab"
                                            aria-controls="structure" aria-selected="false">Структура</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="format-tab" data-bs-toggle="tab"
                                            data-bs-target="#format" type="button" role="tab"
                                            aria-controls="format" aria-selected="false">Формат</button>
                                </li>
                            </ul>

                            <div class="tab-content pt-3" id="importParamsContent">
                                <!-- Основные параметры (существующие) -->
                                <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <!-- Поле скрыто, так как значение выбирается в компоненте field-selection -->
                                            <input type="hidden" id="mappingId" name="mappingId" value="">
                                            <label for="strategyId" class="form-label">Стратегия импорта</label>
                                            <select class="form-select" id="strategyId" name="strategyId">
                                                <option value="">По умолчанию</option>
                                                <!-- Опции будут добавлены динамически -->
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="errorHandling" class="form-label">Обработка ошибок</label>
                                            <select class="form-select" id="errorHandling" name="params[errorHandling]">
                                                <option value="continue">Продолжать при ошибках</option>
                                                <option value="stop">Остановить при первой ошибке</option>
                                                <option value="report">Собирать отчет об ошибках</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="duplicateHandling" class="form-label">Обработка дубликатов</label>
                                            <select class="form-select" id="duplicateHandling" name="params[duplicateHandling]">
                                                <option value="skip">Пропускать дубликаты</option>
                                                <option value="update">Обновлять существующие записи</option>
                                                <option value="error">Выдавать ошибку при дубликатах</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="validateData"
                                                       name="params[validateData]" value="true" checked>
                                                <label class="form-check-label" for="validateData">
                                                    Валидировать данные перед импортом
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="trimWhitespace"
                                                       name="params[trimWhitespace]" value="true" checked>
                                                <label class="form-check-label" for="trimWhitespace">
                                                    Удалять лишние пробелы
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Параметры структуры данных -->
                                <div class="tab-pane fade" id="structure" role="tabpanel" aria-labelledby="structure-tab">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="headerRowInput" class="form-label">Строка заголовков</label>
                                            <input type="number" class="form-control" id="headerRowInput" name="params[headerRow]" value="0" min="0">
                                            <small class="form-text text-muted">Номер строки с заголовками (начиная с 0)</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="dataStartRow" class="form-label">Начальная строка данных</label>
                                            <input type="number" class="form-control" id="dataStartRow" name="params[dataStartRow]" value="1" min="1">
                                            <small class="form-text text-muted">Номер строки, с которой начинаются данные</small>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="skipEmptyRows" name="params[skipEmptyRows]" value="true" checked>
                                                <label class="form-check-label" for="skipEmptyRows">Пропускать пустые строки</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="autoDetectTypes" name="params[autoDetectTypes]" value="true" checked>
                                                <label class="form-check-label" for="autoDetectTypes">Автоопределение типов данных</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="dateFormat" class="form-label">Формат дат</label>
                                            <select class="form-select" id="dateFormat" name="params[dateFormat]">
                                                <option value="auto">Автоопределение</option>
                                                <option value="dd.MM.yyyy">DD.MM.YYYY (31.12.2023)</option>
                                                <option value="yyyy-MM-dd">YYYY-MM-DD (2023-12-31)</option>
                                                <option value="MM/dd/yyyy">MM/DD/YYYY (12/31/2023)</option>
                                                <option value="dd/MM/yyyy">DD/MM/YYYY (31/12/2023)</option>
                                                <option value="custom">Свой формат...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3" id="customDateFormatContainer" style="display: none;">
                                            <label for="customDateFormat" class="form-label">Свой формат даты</label>
                                            <input type="text" class="form-control" id="customDateFormat" name="params[customDateFormat]" placeholder="Например: yyyy.MM.dd HH:mm:ss">
                                            <small class="form-text text-muted">
                                                Используйте: y (год), M (месяц), d (день), H (часы), m (минуты), s (секунды)
                                            </small>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="emptyFieldHandling" class="form-label">Обработка пустых ячеек</label>
                                            <select class="form-select" id="emptyFieldHandling" name="params[emptyFieldHandling]">
                                                <option value="empty">Оставлять пустыми</option>
                                                <option value="null">Установить NULL</option>
                                                <option value="default">Использовать значения по умолчанию</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3 xlsx-only">
                                            <label for="sheetIndex" class="form-label">Лист Excel</label>
                                            <input type="number" class="form-control" id="sheetIndex" name="params[sheetIndex]" value="0" min="0" placeholder="Индекс начиная с 0">
                                            <small class="form-text text-muted">Индекс листа (начиная с 0)</small>
                                        </div>
                                    </div>

                                    <div class="row xlsx-only">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="evaluateFormulas" name="params[evaluateFormulas]" value="true" checked>
                                                <label class="form-check-label" for="evaluateFormulas">Вычислять формулы</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Параметры формата файла -->
                                <div class="tab-pane fade" id="format" role="tabpanel" aria-labelledby="format-tab">
                                    <!-- Параметры только для CSV файлов -->
                                    <div class="csv-only">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="delimiter" class="form-label">Разделитель полей</label>
                                                <select class="form-select" id="delimiter" name="params[delimiter]">
                                                    <option value="auto">Автоопределение</option>
                                                    <option value=";">Точка с запятой (;)</option>
                                                    <option value=",">Запятая (,)</option>
                                                    <option value="\t">Табуляция</option>
                                                    <option value="|">Вертикальная черта (|)</option>
                                                    <option value=" ">Пробел</option>
                                                    <option value="custom">Другой...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3" id="customDelimiterContainer" style="display: none;">
                                                <label for="customDelimiter" class="form-label">Укажите разделитель</label>
                                                <input type="text" class="form-control" id="customDelimiter" name="params[customDelimiter]" maxlength="1">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="quoteChar" class="form-label">Символ обрамления текста</label>
                                                <select class="form-select" id="quoteChar" name="params[quoteChar]">
                                                    <option value="auto">Автоопределение</option>
                                                    <option value="&quot;">Двойные кавычки (&quot;)</option>
                                                    <option value="'">Одинарные кавычки (')</option>
                                                    <option value="">Без обрамления</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="encoding" class="form-label">Кодировка файла</label>
                                                <select class="form-select" id="encoding" name="params[encoding]">
                                                    <option value="auto">Автоопределение</option>
                                                    <option value="UTF-8">UTF-8</option>
                                                    <option value="windows-1251">Windows-1251 (кириллица)</option>
                                                    <option value="CP1252">CP1252 (западноевропейская)</option>
                                                    <option value="ISO-8859-1">ISO-8859-1 (латиница)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="escapeChar" class="form-label">Символ экранирования</label>
                                                <select class="form-select" id="escapeChar" name="params[escapeChar]">
                                                    <option value="auto">Автоопределение</option>
                                                    <option value="\">Обратная косая черта (\)</option>
                                                    <option value="">Без экранирования</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="mt-4 text-center">
                    <button type="submit" id="startImportBtn" class="btn btn-primary btn-lg px-4" disabled>
                        <i class="fas fa-file-import me-1"></i>Начать импорт
                    </button>
                    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-outline-secondary btn-lg px-4 ms-2">
                        <i class="fas fa-times me-1"></i>Отмена
                    </a>
                </div>

                <!-- Прогресс импорта -->
                <div id="importProgress" class="progress-container d-none">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-3">Прогресс импорта</h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
                                     aria-valuemax="100">0%
                                </div>
                            </div>
                            <div id="importStatus">Подготовка к импорту...</div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Получаем ссылки на основные DOM-элементы
        const importForm = document.getElementById('importForm');
        const fileInput = document.getElementById('fileInput');
        const startImportBtn = document.getElementById('startImportBtn');
        const dropArea = document.getElementById('dropArea');
        const filePreview = document.getElementById('filePreview');
        const removeFileBtn = document.getElementById('removeFile');
        const progressContainer = document.getElementById('importProgress');

        // Синхронизируем значение mappingId с компонентом выбора полей
        const selectedMappingIdField = document.getElementById('selectedMappingId');
        const mappingIdField = document.getElementById('mappingId');

        // Синхронизируем поля, если они существуют
        if (selectedMappingIdField && mappingIdField) {
            // Начальная синхронизация значений
            mappingIdField.value = selectedMappingIdField.value;

            // Следим за изменениями в компоненте выбора полей
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        mappingIdField.value = selectedMappingIdField.value;
                    }
                });
            });

            observer.observe(selectedMappingIdField, {attributes: true});
        }

        // Обработка клика по области загрузки
        dropArea.addEventListener('click', () => fileInput.click());

        // Обработка перетаскивания файла
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragging'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragging'), false);
        });

        // Обработка выбора файла
        fileInput.addEventListener('change', e => {
            if (e.target.files && e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        dropArea.addEventListener('drop', e => {
            const dt = e.dataTransfer;
            if (dt.files && dt.files.length > 0) {
                fileInput.files = dt.files;
                handleFile(dt.files[0]);
            }
        });

        // Определение типа файла и соответствующих параметров
        function updateFileSpecificParams() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) return;

            const fileName = fileInput.files[0].name.toLowerCase();
            const isXlsx = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
            const isCsv = fileName.endsWith('.csv');

            // Показываем/скрываем параметры в зависимости от типа файла
            document.querySelectorAll('.csv-only').forEach(el => {
                el.style.display = isCsv ? 'block' : 'none';
            });

            document.querySelectorAll('.xlsx-only').forEach(el => {
                el.style.display = isXlsx ? 'block' : 'none';
            });
        }

        // Обработка пользовательского формата даты
        const dateFormatSelect = document.getElementById('dateFormat');
        const customDateFormatContainer = document.getElementById('customDateFormatContainer');
        if (dateFormatSelect && customDateFormatContainer) {
            dateFormatSelect.addEventListener('change', function() {
                customDateFormatContainer.style.display =
                    this.value === 'custom' ? 'block' : 'none';
            });
        }

        // Обработка пользовательского разделителя
        const delimiterSelect = document.getElementById('delimiter');
        const customDelimiterContainer = document.getElementById('customDelimiterContainer');
        if (delimiterSelect && customDelimiterContainer) {
            delimiterSelect.addEventListener('change', function() {
                customDelimiterContainer.style.display =
                    this.value === 'custom' ? 'block' : 'none';
            });
        }

        function handleFile(file) {
            // Показываем превью файла
            filePreview.style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || getFileExtension(file.name);

            // Активируем кнопку импорта
            startImportBtn.disabled = false;

            // Обновляем параметры в зависимости от типа файла
            updateFileSpecificParams();

            // Анализируем файл
            analyzeFile(file);
        }

        // Удаление файла
        removeFileBtn.addEventListener('click', function () {
            fileInput.value = '';
            filePreview.style.display = 'none';
            startImportBtn.disabled = true;
        });

        // Функция для сбора всех параметров импорта
        function collectImportParameters(form) {
            // Собираем значения выборочных полей
            const paramsByType = {
                'select': ['errorHandling', 'duplicateHandling', 'dateFormat', 'emptyFieldHandling',
                    'delimiter', 'quoteChar', 'encoding', 'escapeChar'],
                'checkbox': ['validateData', 'trimWhitespace', 'skipEmptyRows', 'autoDetectTypes', 'evaluateFormulas'],
                'number': ['headerRowInput', 'dataStartRow', 'sheetIndex'] // Заменили headerRow на headerRowInput
            };

            // Собираем параметры по типам элементов
            for (const [type, ids] of Object.entries(paramsByType)) {
                ids.forEach(id => {
                    const element = document.getElementById(id);
                    if (!element) return;

                    let value;
                    if (type === 'checkbox') {
                        value = element.checked ? element.value || 'true' : 'false';
                    } else {
                        value = element.value;
                    }

                    // Специальная обработка для headerRowInput, так как имя параметра отличается от id
                    const paramName = id === 'headerRowInput'
                        ? 'params[headerRow]'
                        : `params[${id}]`;

                    let existingField = form.querySelector(`input[name="${paramName}"]`);

                    if (!existingField) {
                        // Если поле не существует, создаем его
                        const hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = paramName;
                        hiddenField.value = value;
                        form.appendChild(hiddenField);
                    } else {
                        // Если поле существует, обновляем его значение
                        existingField.value = value;
                    }
                });
            }

            // Специальная обработка для полей с пользовательскими значениями
            // Пользовательский формат даты
            if (dateFormatSelect && dateFormatSelect.value === 'custom') {
                const customDateFormat = document.getElementById('customDateFormat');
                if (customDateFormat && customDateFormat.value) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = 'params[datePattern]';
                    hiddenField.value = customDateFormat.value;
                    form.appendChild(hiddenField);
                }
            }

            // Пользовательский разделитель
            if (delimiterSelect && delimiterSelect.value === 'custom') {
                const customDelimiter = document.getElementById('customDelimiter');
                if (customDelimiter && customDelimiter.value) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = 'params[delimiter]';
                    hiddenField.value = customDelimiter.value;
                    form.appendChild(hiddenField);
                }
            }

            return true;
        }

        // Добавляем прямой обработчик клика на кнопку импорта
        startImportBtn.addEventListener('click', function (event) {
            // Проверка формы
            const form = document.getElementById('importForm');
            if (!form) return;

            // Проверка файла
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Пожалуйста, выберите файл для импорта');
                event.preventDefault();
                return;
            }

            // Собираем все параметры импорта
            collectImportParameters(form);

            // Показываем прогресс импорта
            progressContainer.classList.remove('d-none');

            // Обновляем прогресс-бар
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('importStatus');
            progressBar.style.width = '30%';
            progressBar.setAttribute('aria-valuenow', 30);
            progressBar.textContent = '30%';
            statusText.textContent = 'Отправка файла...';

            // Отправляем форму программно
            form.submit();

            // Предотвращаем стандартное действие кнопки
            event.preventDefault();
        });

        // Функции для работы с файлами и анализа
        function updateMappingOptions(mappings) {
            const mappingSelect = document.getElementById('mappingSelect');

            // Если элемент не найден, пробуем найти по альтернативному ID
            if (!mappingSelect) {
                const altSelect = document.getElementById('mappingId');
                if (altSelect) {
                    updateMappingOptionsForElement(altSelect, mappings);
                }
                return;
            }

            updateMappingOptionsForElement(mappingSelect, mappings);
        }

        function updateMappingOptionsForElement(selectElement, mappings) {
            // Очищаем текущие опции
            selectElement.innerHTML = '<option value="">Автоматическое</option>';

            // Добавляем доступные маппинги
            if (mappings && mappings.length > 0) {
                mappings.forEach(mapping => {
                    const option = document.createElement('option');
                    option.value = mapping.id;
                    option.textContent = mapping.name + (mapping.composite ? ' (составной)' : '');
                    selectElement.appendChild(option);
                });
            }
        }

        function formatFileSize(size) {
            const kb = 1024;
            const mb = kb * 1024;

            if (size < kb) {
                return size + ' B';
            } else if (size < mb) {
                return (size / kb).toFixed(2) + ' KB';
            } else {
                return (size / mb).toFixed(2) + ' MB';
            }
        }

        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf('.') - 1 >>> 0) + 2);
        }

        function analyzeFile(file) {
            // Очищаем таблицу предпросмотра
            const headerRow = document.getElementById('headerRow');
            const previewBody = document.getElementById('previewBody');

            if (!headerRow || !previewBody) return;

            headerRow.innerHTML = '<th class="text-center" colspan="10"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div> Анализ файла...</th>';
            previewBody.innerHTML = '';

            // Получаем параметры анализа
            const entityType = document.getElementById('selectedEntityType')?.value || 'product';
            const isComposite = document.getElementById('isComposite')?.value === 'true';
            const clientId = window.location.pathname.split('/')[2]; // ID клиента из URL

            // Создаем форму для отправки файла
            const formData = new FormData();
            formData.append('file', file);
            formData.append('analysisEntityType', entityType);
            formData.append('composite', isComposite);

            // Отправляем файл на сервер для анализа
            fetch(`/clients/${clientId}/import/analyze`, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Очищаем строки таблицы
                    headerRow.innerHTML = '';
                    previewBody.innerHTML = '';

                    // Заполняем заголовки, если они есть
                    if (data.headers && data.headers.length > 0) {
                        data.headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                    }

                    // Заполняем предпросмотр данных первыми 10 строками
                    if (data.sampleData && data.sampleData.length > 0) {
                        data.sampleData.forEach(rowObject => {
                            const tr = document.createElement('tr');

                            // Для каждого заголовка получаем соответствующее значение
                            if (data.headers && data.headers.length > 0) {
                                data.headers.forEach(header => {
                                    const td = document.createElement('td');
                                    const cellValue = rowObject[header] !== undefined ? rowObject[header] : '';
                                    td.textContent = cellValue;
                                    tr.appendChild(td);
                                });
                            } else {
                                // Если заголовки не определены, выводим все значения объекта
                                Object.values(rowObject).forEach(value => {
                                    const td = document.createElement('td');
                                    td.textContent = value !== null ? value : '';
                                    tr.appendChild(td);
                                });
                            }

                            previewBody.appendChild(tr);
                        });

                        // Сообщаем, сколько всего строк в файле
                        const totalRows = data.totalRows || data.sampleData.length;
                        if (totalRows > data.sampleData.length) {
                            const tr = document.createElement('tr');
                            const td = document.createElement('td');
                            td.colSpan = data.headers ? data.headers.length : Object.keys(data.sampleData[0]).length;
                            td.className = 'text-center text-muted';
                            td.textContent = `...и еще ${totalRows - data.sampleData.length} строк`;
                            tr.appendChild(td);
                            previewBody.appendChild(tr);
                        }
                    }

                    // Автоматическое обновление параметров импорта на основе обнаруженных данных
                    if (data.detectedOptions) {
                        // Обновляем разделитель, если он обнаружен и есть соответствующее поле
                        if (data.detectedOptions.delimiter && delimiterSelect) {
                            const detectedDelimiter = data.detectedOptions.delimiter;
                            // Проверяем, есть ли такой разделитель в списке
                            const options = Array.from(delimiterSelect.options);
                            const option = options.find(opt => opt.value === detectedDelimiter);
                            if (option) {
                                delimiterSelect.value = detectedDelimiter;
                            }
                        }

                        // Обновляем другие обнаруженные параметры
                        if (data.detectedOptions.quoteChar) {
                            const quoteCharSelect = document.getElementById('quoteChar');
                            if (quoteCharSelect) {
                                const options = Array.from(quoteCharSelect.options);
                                const option = options.find(opt => opt.value === data.detectedOptions.quoteChar);
                                if (option) {
                                    quoteCharSelect.value = data.detectedOptions.quoteChar;
                                }
                            }
                        }

                        if (data.detectedOptions.charset) {
                            const encodingSelect = document.getElementById('encoding');
                            if (encodingSelect) {
                                const options = Array.from(encodingSelect.options);
                                const option = options.find(opt => opt.value.toLowerCase() === data.detectedOptions.charset.toLowerCase());
                                if (option) {
                                    encodingSelect.value = option.value;
                                }
                            }
                        }

                        if (data.detectedOptions.headerRow !== undefined) {
                            const headerRowInput = document.getElementById('headerRowInput');
                            if (headerRowInput) {
                                headerRowInput.value = data.detectedOptions.headerRow;
                            }
                        }
                    }

                    // Обновляем доступные маппинги
                    if (data.availableMappings) {
                        updateMappingOptions(data.availableMappings);
                    }

                    // Сохраняем заголовки и данные для использования при создании маппинга
                    window.fileHeaders = data.headers || [];
                    window.fieldsMetadata = data.fieldsMetadata;

                    // Диспатчим событие для компонента field-selection
                    document.dispatchEvent(new CustomEvent('fileAnalyzed', {
                        detail: {
                            headers: data.headers || [],
                            metadata: data.fieldsMetadata
                        }
                    }));

                    // Если нет данных для предпросмотра
                    if ((!data.headers || data.headers.length === 0) &&
                        (!data.sampleData || data.sampleData.length === 0)) {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 5;
                        td.className = 'text-center text-muted py-3';
                        td.textContent = 'Не удалось прочитать данные из файла или файл пуст';
                        tr.appendChild(td);
                        previewBody.appendChild(tr);
                    }
                })
                .catch(error => {
                    headerRow.innerHTML = '';
                    previewBody.innerHTML = '';

                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 5;
                    td.className = 'text-center text-danger py-3';
                    td.textContent = 'Ошибка при анализе файла: ' + error.message;
                    tr.appendChild(td);
                    previewBody.appendChild(tr);
                });
        }

        // Активируем кнопку "Начать импорт" если файл уже был выбран при загрузке страницы
        if (fileInput.files && fileInput.files.length > 0) {
            startImportBtn.disabled = false;
            updateFileSpecificParams(); // Обновляем параметры в зависимости от типа файла
        }

        // Инициализация при загрузке страницы
        updateFileSpecificParams();
    });
</script>
</body>
</html>