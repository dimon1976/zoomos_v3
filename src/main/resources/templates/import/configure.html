<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Настройка импорта - Обработка файлов',
        ~{::section},
        ~{::script},
        ~{::style},
        'Настройка импорта файла ' + ${fileName},
        ~{::.page-actions}
      )}">
<head>
    <title>Настройка импорта - Обработка файлов</title>
    <style>
        .file-info-container {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .file-name {
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        .file-name i {
            margin-right: 0.5rem;
        }
        .file-details {
            color: #6c757d;
            margin-top: 0.5rem;
        }
        .mapping-card {
            border: 1px solid rgba(0,0,0,.125);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .mapping-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .mapping-card.selected {
            border-color: #007bff;
            background-color: #f1f8ff;
        }
        .mapping-card.create-new {
            border-style: dashed;
            text-align: center;
            cursor: pointer;
        }
        .mapping-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .mapping-title {
            font-weight: bold;
            margin-right: auto;
        }
        .mapping-radio {
            margin-left: 1rem;
        }
        .mapping-description {
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .mapping-details {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .table-scroll {
            max-height: 300px;
            overflow-y: auto;
        }
        .sticky-header th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }
        .mapping-table {
            margin-top: 1.5rem;
        }
        .mapping-table select {
            width: 100%;
        }
        .source-header {
            background-color: #f1f8ff;
        }
        .target-header {
            background-color: #f8f1ff;
        }
        .header-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .source-indicator {
            background-color: #007bff;
        }
        .target-indicator {
            background-color: #6f42c1;
        }
        .import-options {
            margin-top: 2rem;
        }
        .sample-data-container {
            margin-top: 1.5rem;
        }
        .tab-content {
            padding-top: 1.5rem;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/import/{clientId}(clientId=${client.id})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Назад к загрузке
    </a>
</div>

<section>
    <!-- Информация о файле -->
    <div class="file-info-container">
        <div class="file-name">
            <i class="fas fa-file-alt text-primary"></i>
            <span th:text="${fileName}">filename.csv</span>
        </div>
        <div class="file-details">
            <span th:text="${fileSize}">1.2 MB</span> |
            <span th:text="${analysis.processorType}">CSV Processor</span> |
            <span th:if="${analysis.estimatedRows != null}">
                Примерно <span th:text="${analysis.estimatedRows}">100</span> записей
            </span>
        </div>
    </div>

    <!-- Форма импорта -->
    <form id="importForm" th:action="@{/import/{clientId}/import(clientId=${client.id})}" method="post" enctype="multipart/form-data">
        <!-- Скрытое поле для файла -->
        <input type="hidden" name="fileName" th:value="${fileName}" />
        <input type="file" id="fileInput" name="file" style="display: none;" />

        <!-- Вкладки настройки -->
        <ul class="nav nav-tabs" id="importTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping"
                        type="button" role="tab" aria-controls="mapping" aria-selected="true">
                    <i class="fas fa-map-signs me-1"></i>Сопоставление полей
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sample-tab" data-bs-toggle="tab" data-bs-target="#sample"
                        type="button" role="tab" aria-controls="sample" aria-selected="false">
                    <i class="fas fa-table me-1"></i>Образец данных
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options"
                        type="button" role="tab" aria-controls="options" aria-selected="false">
                    <i class="fas fa-cogs me-1"></i>Настройки импорта
                </button>
            </li>
        </ul>

        <div class="tab-content" id="importTabsContent">
            <!-- Вкладка сопоставления полей -->
            <div class="tab-pane fade show active" id="mapping" role="tabpanel" aria-labelledby="mapping-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Выберите схему сопоставления полей</h5>

                        <!-- Список доступных маппингов -->
                        <div class="row">
                            <div class="col-md-6 mb-3" th:each="mapping : ${availableMappings}">
                                <div class="mapping-card" th:data-mapping-id="${mapping.id}">
                                    <div class="mapping-header">
                                        <div class="mapping-title" th:text="${mapping.name}">Default Mapping</div>
                                        <div class="mapping-radio">
                                            <input type="radio" th:id="'mapping_' + ${mapping.id}" name="mappingId"
                                                   th:value="${mapping.id}" class="form-check-input mapping-selector" />
                                        </div>
                                    </div>
                                    <div class="mapping-description" th:text="${mapping.description}">
                                        Standard field mapping for product imports
                                    </div>
                                    <div class="mapping-details">
                                        <small th:text="'Полей: ' + ${mapping.fields_count}">12 fields</small>
                                        <small class="ms-2" th:if="${mapping.client_id == client.id}">
                                            <span class="badge bg-primary">Персональный</span>
                                        </small>
                                        <small class="ms-2" th:if="${mapping.client_id == null}">
                                            <span class="badge bg-secondary">Общий</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Создать новую схему сопоставления -->
                            <div class="col-md-6 mb-3">
                                <div class="mapping-card create-new" data-mapping-id="new">
                                    <div class="mapping-header">
                                        <div class="mapping-title">Создать новую схему</div>
                                        <div class="mapping-radio">
                                            <input type="radio" id="mapping_new" name="mappingId" value="new"
                                                   class="form-check-input mapping-selector" checked />
                                        </div>
                                    </div>
                                    <div class="mapping-description">
                                        <i class="fas fa-plus-circle me-1"></i>Настроить собственную схему сопоставления полей
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Таблица сопоставления полей -->
                        <div id="mappingTableContainer" class="mapping-table">
                            <h5>Настройка сопоставления полей</h5>
                            <p class="text-muted">Укажите, каким полям сущности соответствуют поля из файла.</p>

                            <div class="d-flex align-items-center mb-2">
                                <div class="me-3">
                                    <span class="header-indicator source-indicator"></span>
                                    <strong>Поля из файла</strong>
                                </div>
                                <div>
                                    <span class="header-indicator target-indicator"></span>
                                    <strong>Поля сущности</strong>
                                </div>
                                <div class="ms-auto">
                                    <select id="entityTypeSelect" name="entityType" class="form-select form-select-sm" style="width: 200px;">
                                        <option value="product" selected>Товар (Product)</option>
                                        <option value="regiondata">Регион (RegionData)</option>
                                        <option value="competitordata">Конкурент (CompetitorData)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="table-scroll">
                                <table class="table table-bordered table-hover">
                                    <thead class="sticky-header">
                                    <tr>
                                        <th class="source-header">Поле в файле</th>
                                        <th class="target-header">Поле сущности</th>
                                    </tr>
                                    </thead>
                                    <tbody id="mappingTableBody">
                                    <tr th:each="header, stat : ${analysis.headers}">
                                        <td class="source-header" th:text="${header}">Product Name</td>
                                        <td>
                                            <select th:name="'mapping[' + ${header} + ']'" class="form-select entity-field-selector">
                                                <option value="">-- Не импортировать --</option>
                                                <!-- Опции будут заполнены динамически -->
                                            </select>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Сохранение схемы сопоставления -->
                            <div class="mt-3 form-check">
                                <input type="checkbox" class="form-check-input" id="saveMapping" name="saveMapping" value="true">
                                <label class="form-check-label" for="saveMapping">
                                    Сохранить эту схему сопоставления для будущего использования
                                </label>
                            </div>
                            <div id="saveMappingOptions" class="mt-2" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="mappingName" class="form-label">Название схемы</label>
                                            <input type="text" class="form-control" id="mappingName" name="mappingName"
                                                   placeholder="Например: Импорт товаров из 1С">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="mappingDescription" class="form-label">Описание (опционально)</label>
                                            <input type="text" class="form-control" id="mappingDescription" name="mappingDescription"
                                                   placeholder="Краткое описание схемы">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка образца данных -->
            <div class="tab-pane fade" id="sample" role="tabpanel" aria-labelledby="sample-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Образец данных из файла</h5>
                        <p class="text-muted">Показаны первые 10 строк из файла для предварительного просмотра.</p>

                        <div class="table-scroll">
                            <table class="table table-sm table-bordered">
                                <thead class="sticky-header">
                                <tr>
                                    <th>#</th>
                                    <th th:each="header : ${analysis.headers}" th:text="${header}">Header</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="row, rowStat : ${analysis.sampleData}">
                                    <td th:text="${rowStat.count}">1</td>
                                    <td th:each="header : ${analysis.headers}" th:text="${row[header]}">Value</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <span th:if="${analysis.estimatedRows != null}">
                                Всего в файле примерно <strong th:text="${analysis.estimatedRows}">100</strong> записей
                            </span>
                            <span th:unless="${analysis.estimatedRows != null}">
                                Количество записей в файле не определено
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка настроек импорта -->
            <div class="tab-pane fade" id="options" role="tabpanel" aria-labelledby="options-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Настройки процесса импорта</h5>

                        <div class="row">
                            <!-- Общие настройки -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="processingStrategy" class="form-label">Стратегия обработки</label>
                                    <select class="form-select" id="processingStrategy" name="processingStrategy">
                                        <option value="insert" selected>Только вставка новых записей</option>
                                        <option value="update">Обновление существующих записей</option>
                                        <option value="upsert">Вставка новых и обновление существующих</option>
                                        <option value="replace">Замена всех существующих записей</option>
                                    </select>
                                    <div class="form-text">Определяет, как обрабатывать существующие записи</div>
                                </div>

                                <div class="mb-3">
                                    <label for="batchSize" class="form-label">Размер пакета</label>
                                    <select class="form-select" id="batchSize" name="batchSize">
                                        <option value="100">100 записей</option>
                                        <option value="500" selected>500 записей</option>
                                        <option value="1000">1000 записей</option>
                                        <option value="5000">5000 записей</option>
                                    </select>
                                    <div class="form-text">Количество записей, обрабатываемых за один раз</div>
                                </div>
                            </div>

                            <!-- Обработка ошибок -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="errorHandling" class="form-label">Обработка ошибок</label>
                                    <select class="form-select" id="errorHandling" name="errorHandling">
                                        <option value="stop">Остановить процесс при ошибке</option>
                                        <option value="continue" selected>Пропускать ошибочные записи и продолжать</option>
                                        <option value="report">Собирать ошибки в отчет и продолжать</option>
                                    </select>
                                    <div class="form-text">Определяет, что делать при обнаружении ошибки в записи</div>
                                </div>

                                <div class="mb-3">
                                    <label for="duplicateHandling" class="form-label">Обработка дубликатов</label>
                                    <select class="form-select" id="duplicateHandling" name="duplicateHandling">
                                        <option value="skip" selected>Пропускать дубликаты</option>
                                        <option value="update">Обновлять существующие записи</option>
                                        <option value="error">Выдавать ошибку при дубликате</option>
                                    </select>
                                    <div class="form-text">Определяет, что делать при обнаружении дублирующейся записи</div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4">Дополнительные параметры</h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="validateData" name="validateData" checked>
                                    <label class="form-check-label" for="validateData">
                                        Валидировать данные перед импортом
                                    </label>
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="trimWhitespace" name="trimWhitespace" checked>
                                    <label class="form-check-label" for="trimWhitespace">
                                        Удалять лишние пробелы в строковых полях
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="generateReport" name="generateReport" checked>
                                    <label class="form-check-label" for="generateReport">
                                        Генерировать отчет о результатах импорта
                                    </label>
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="notifyOnComplete" name="notifyOnComplete" checked>
                                    <label class="form-check-label" for="notifyOnComplete">
                                        Уведомить о завершении импорта
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="d-flex justify-content-between mt-4">
            <a th:href="@{/import/{clientId}(clientId=${client.id})}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Назад
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-file-import me-1"></i>Начать импорт
            </button>
        </div>
    </form>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация файла в форме
        initFileInput();

        // Обработка выбора схемы сопоставления
        initMappingSelectors();

        // Обработка изменения типа сущности
        initEntityTypeSelector();

        // Обработка флажка сохранения схемы
        initSaveMappingCheckbox();

        // Загрузка полей сущности при инициализации
        loadEntityFields('product');

        // Заполнение сопоставления полей, если выбрана схема
        checkForAutomaticMapping();
    });

    // Инициализация файла в форме
    function initFileInput() {
        // Получаем файл с предыдущей страницы через localStorage или через сессию
        // В реальном приложении здесь должен быть код, который восстанавливает файл

        // Для демонстрации просто устанавливаем имя файла
        const fileNameElement = document.querySelector('[name="fileName"]');
        if (fileNameElement) {
            const fileName = fileNameElement.value;

            // Нужно передать тот же файл обратно при отправке формы
            // В реальном приложении здесь будет код для восстановления файла и установки его в форму
        }
    }

    // Инициализация обработчиков для селекторов схем
    function initMappingSelectors() {
        const mappingCards = document.querySelectorAll('.mapping-card');
        const mappingSelectors = document.querySelectorAll('.mapping-selector');

        // Обработка клика по карточке схемы
        mappingCards.forEach(card => {
            card.addEventListener('click', function() {
                const mappingId = this.dataset.mappingId;
                const radio = document.getElementById('mapping_' + mappingId);

                // Выбираем соответствующий радиобаттон
                if (radio) {
                    radio.checked = true;

                    // Обновляем стили карточек
                    updateMappingCardStyles();

                    // Если выбрана существующая схема, загружаем её данные
                    if (mappingId !== 'new') {
                        loadMappingData(mappingId);
                    }
                }
            });
        });

        // Обработка изменения радиобаттона
        mappingSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                updateMappingCardStyles();

                const mappingId = this.value;
                if (mappingId !== 'new') {
                    loadMappingData(mappingId);
                }
            });
        });

        // Обновляем стили при загрузке страницы
        updateMappingCardStyles();
    }

    // Обновление стилей карточек схем
    function updateMappingCardStyles() {
        const mappingCards = document.querySelectorAll('.mapping-card');

        mappingCards.forEach(card => {
            const mappingId = card.dataset.mappingId;
            const radio = document.getElementById('mapping_' + mappingId);

            if (radio && radio.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    // Загрузка данных схемы сопоставления
    function loadMappingData(mappingId) {
        // В реальном приложении здесь будет AJAX-запрос для получения данных схемы
        console.log('Loading mapping data for ID: ' + mappingId);

        // Эмуляция запроса
        fetch(`/import/api/mappings/${mappingId}`)
            .then(response => response.json())
            .then(data => {
                // Заполнение селекторов полей
                fillFieldSelectors(data.fieldMapping);
            })
            .catch(error => {
                console.error('Error loading mapping data:', error);
            });
    }

    // Инициализация выбора типа сущности
    function initEntityTypeSelector() {
        const entityTypeSelect = document.getElementById('entityTypeSelect');

        if (entityTypeSelect) {
            entityTypeSelect.addEventListener('change', function() {
                const entityType = this.value;
                loadEntityFields(entityType);
            });
        }
    }

    // Загрузка полей сущности
    function loadEntityFields(entityType) {
        console.log('Loading entity fields for type: ' + entityType);

        // В реальном приложении здесь будет AJAX-запрос
        // Для демонстрации используем заглушки

        let fields = [];

        if (entityType === 'product') {
            fields = [
                { name: 'productId', displayName: 'ID товара' },
                { name: 'productName', displayName: 'Название товара' },
                { name: 'productBrand', displayName: 'Бренд' },
                { name: 'productBar', displayName: 'Штрихкод' },
                { name: 'productDescription', displayName: 'Описание' },
                { name: 'productUrl', displayName: 'URL товара' },
                { name: 'productCategory1', displayName: 'Категория 1' },
                { name: 'productCategory2', displayName: 'Категория 2' },
                { name: 'productCategory3', displayName: 'Категория 3' },
                { name: 'productPrice', displayName: 'Цена' },
                { name: 'productAnalog', displayName: 'Аналог' }
            ];
        } else if (entityType === 'regiondata') {
            fields = [
                { name: 'region', displayName: 'Регион' },
                { name: 'regionAddress', displayName: 'Адрес' }
            ];
        } else if (entityType === 'competitordata') {
            fields = [
                { name: 'competitorName', displayName: 'Название конкурента' },
                { name: 'competitorPrice', displayName: 'Цена у конкурента' },
                { name: 'competitorUrl', displayName: 'URL конкурента' },
                { name: 'competitorProductName', displayName: 'Название товара у конкурента' }
            ];
        }

        // Заполняем все селекторы полей
        const fieldSelectors = document.querySelectorAll('.entity-field-selector');

        fieldSelectors.forEach(selector => {
            // Сохраняем текущее значение
            const currentValue = selector.value;

            // Очищаем селектор
            selector.innerHTML = '';

            // Добавляем опцию "Не импортировать"
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.text = '-- Не импортировать --';
            selector.appendChild(emptyOption);

            // Добавляем поля сущности
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.name;
                option.text = field.displayName;
                selector.appendChild(option);
            });

            // Восстанавливаем выбранное значение, если оно есть среди новых опций
            if (currentValue) {
                for (let i = 0; i < selector.options.length; i++) {
                    if (selector.options[i].value === currentValue) {
                        selector.selectedIndex = i;
                        break;
                    }
                }
            }
        });

        // После загрузки полей проверяем, можно ли автоматически сопоставить их
        suggestFieldMapping();
    }

    // Инициализация флажка сохранения схемы
    function initSaveMappingCheckbox() {
        const saveMapping = document.getElementById('saveMapping');
        const saveMappingOptions = document.getElementById('saveMappingOptions');

        if (saveMapping && saveMappingOptions) {
            saveMapping.addEventListener('change', function() {
                if (this.checked) {
                    saveMappingOptions.style.display = 'block';
                } else {
                    saveMappingOptions.style.display = 'none';
                }
            });
        }
    }

    // Заполнение селекторов полей на основе существующей схемы
    function fillFieldSelectors(mapping) {
        if (!mapping) return;

        const fieldSelectors = document.querySelectorAll('.entity-field-selector');

        fieldSelectors.forEach(selector => {
            // Получаем имя поля из файла
            const sourceField = selector.closest('tr').querySelector('td:first-child').textContent;

            // Ищем соответствующее поле сущности в маппинге
            const targetField = mapping[sourceField];

            if (targetField) {
                // Устанавливаем значение селектора
                for (let i = 0; i < selector.options.length; i++) {
                    if (selector.options[i].value === targetField) {
                        selector.selectedIndex = i;
                        break;
                    }
                }
            }
        });
    }

    // Проверка, есть ли автоматически выбранная схема
    function checkForAutomaticMapping() {
        // Проверяем, выбрана ли какая-то схема по умолчанию
        const selectedMapping = document.querySelector('.mapping-selector:checked');

        if (selectedMapping && selectedMapping.value !== 'new') {
            // Загружаем данные схемы
            loadMappingData(selectedMapping.value);
        } else {
            // Предлагаем автоматическое сопоставление
            suggestFieldMapping();
        }
    }

    // Предложение автоматического сопоставления полей
    function suggestFieldMapping() {
        const fieldSelectors = document.querySelectorAll('.entity-field-selector');

        fieldSelectors.forEach(selector => {
            // Получаем имя поля из файла
            const sourceFieldCell = selector.closest('tr').querySelector('td:first-child');
            const sourceField = sourceFieldCell.textContent.trim();

            // Проверяем каждую опцию селектора
            for (let i = 1; i < selector.options.length; i++) {
                const option = selector.options[i];
                const optionText = option.text.toLowerCase();
                const optionValue = option.value.toLowerCase();
                const sourceFieldLower = sourceField.toLowerCase();

                // Ищем совпадение по имени
                if (optionText === sourceFieldLower || optionValue === sourceFieldLower) {
                    selector.selectedIndex = i;
                    return;
                }

                // Ищем частичное совпадение
                if (optionText.includes(sourceFieldLower) || sourceFieldLower.includes(optionText) ||
                    optionValue.includes(sourceFieldLower) || sourceFieldLower.includes(optionValue)) {
                    selector.selectedIndex = i;
                    return;
                }
            }
        });
    }
</script>
</body>
</html>