<!-- src/main/resources/templates/import/form.html -->
<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Импорт данных - Обработка файлов',
        ~{::section},
        ~{::script},
        ~{::style},
        ${client.name + ' - Импорт данных'},
        ~{::.page-actions}
      )}">
<head>
    <title>Импорт данных - Обработка файлов</title>
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragging {
            border-color: #0d6efd;
            background-color: #f1f8ff;
        }
        #filePreview {
            display: none;
            margin-top: 15px;
        }
        .preview-table {
            max-height: 200px;
            overflow-y: auto;
        }
        .compact-form .card-body {
            padding: 1rem;
        }
        .compact-form .mb-4 {
            margin-bottom: 1rem !important;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary btn-sm me-2">
        <i class="fas fa-arrow-left me-1"></i>К клиенту
    </a>
    <a th:href="@{/clients/{id}/operations(id=${client.id})}" class="btn btn-primary btn-sm">
        <i class="fas fa-history me-1"></i>Операции
    </a>
</div>

<section>
    <div class="card mb-4 compact-form">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Импорт данных для клиента</h5>
        </div>
        <div class="card-body">
            <form id="importForm" th:action="@{/clients/{id}/import(id=${client.id})}" method="post" enctype="multipart/form-data" onsubmit="return validateBeforeImport()">
                <!-- Скрытые поля для сущностей -->
                <input type="hidden" id="selectedEntityType" name="entityType" value="product">
                <input type="hidden" id="isComposite" name="composite" value="true">

                <!-- Загрузка файла -->
                <div class="mb-3">
                    <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
                        <input type="file" name="file" id="fileInput" accept=".csv,.xlsx,.xls" class="d-none" required>
                        <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                        <p class="mb-0">Перетащите файл или кликните для выбора</p>
                        <small class="text-muted">CSV, Excel (.xlsx, .xls)</small>
                    </div>

                    <!-- Предпросмотр файла -->
                    <div id="filePreview" class="card">
                        <div class="card-header py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Предпросмотр файла</h6>
                                <button type="button" id="removeFile" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-flex mb-2">
                                <strong class="me-2">Файл:</strong> <span id="fileName"></span>
                                (<span id="fileSize"></span>, <span id="fileType"></span>)
                            </div>
                            <div class="preview-table">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead><tr id="headerRow"></tr></thead>
                                    <tbody id="previewBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Сопоставление полей - добавляем required для обязательного выбора -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0">Сопоставление полей</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label mb-1">Тип данных</label>
                                <select class="form-select form-select-sm" id="entityTypeSelect" onchange="updateEntityType(this.value)">
                                    <option value="product" selected>Товары (составные)</option>
                                    <option value="region">Только регионы</option>
                                    <option value="competitor">Только конкуренты</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label mb-1">Сохраненные шаблоны сопоставления <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="mappingSelect" name="mappingId" required>
                                    <option value="">-- Выберите шаблон сопоставления --</option>
                                    <!-- Опции будут добавлены динамически -->
                                </select>
                                <div class="invalid-feedback">Необходимо выбрать шаблон сопоставления</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <button type="button" id="createMappingBtn" class="btn btn-sm btn-outline-primary" onclick="prepareCreateMappingModal()">
                                <i class="fas fa-plus me-1"></i>Создать сопоставление
                            </button>
                            <button type="button" id="viewMappingBtn" class="btn btn-sm btn-outline-secondary" onclick="showCurrentMapping()" disabled>
                                <i class="fas fa-eye me-1"></i>Просмотреть сопоставление
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Параметры импорта -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0">Параметры импорта</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Обработка ошибок</label>
                                <select class="form-select form-select-sm" name="params[errorHandling]">
                                    <option value="continue">Продолжать при ошибках</option>
                                    <option value="stop">Остановить при первой ошибке</option>
                                    <option value="report">Собирать отчет об ошибках</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Обработка дубликатов</label>
                                <select class="form-select form-select-sm" name="params[duplicateHandling]">
                                    <option value="skip">Пропускать дубликаты</option>
                                    <option value="update">Обновлять существующие записи</option>
                                    <option value="error">Выдавать ошибку при дубликатах</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Расширенные параметры (скрытые по умолчанию) -->
                <div class="card mb-3 d-none" id="advancedSettings">
                    <div class="card-header py-2">
                        <h6 class="mb-0">Расширенные параметры</h6>
                    </div>
                    <div class="card-body p-2">
                        <!-- Параметры структуры файла -->
                        <div class="row g-2 mb-2">
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Строка заголовков</label>
                                <input type="number" class="form-control form-control-sm" name="params[headerRow]" value="0" min="0">
                                <small class="form-text text-muted">Номер строки с заголовками (с 0)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Начальная строка данных</label>
                                <input type="number" class="form-control form-control-sm" name="params[dataStartRow]" value="1" min="1">
                                <small class="form-text text-muted">Номер строки начала данных</small>
                            </div>
                        </div>

                        <!-- Параметры Excel - без стиля display:none! -->
                        <div class="excel-section">
                            <h6 class="small fw-bold mt-3 mb-2">Параметры Excel</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small mb-1">Индекс листа</label>
                                    <input type="number" class="form-control form-control-sm" name="params[sheetIndex]" value="0" min="0">
                                    <small class="form-text text-muted">Начиная с 0</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small mb-1">Имя листа</label>
                                    <input type="text" class="form-control form-control-sm" name="params[sheetName]" placeholder="Лист1">
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="evaluateFormulas" name="params[evaluateFormulas]" value="true" checked>
                                <label class="form-check-label small" for="evaluateFormulas">Вычислять формулы</label>
                            </div>
                        </div>

                        <!-- Параметры CSV - без стиля display:none! -->
                        <div class="csv-section">
                            <h6 class="small fw-bold mt-3 mb-2">Параметры CSV</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Разделитель</label>
                                    <select class="form-select form-select-sm" name="params[delimiter]">
                                        <option value="auto">Автоопределение</option>
                                        <option value=";">Точка с запятой (;)</option>
                                        <option value=",">Запятая (,)</option>
                                        <option value="\t">Табуляция</option>
                                        <option value="|">Вертикальная черта (|)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Обрамление</label>
                                    <select class="form-select form-select-sm" name="params[quoteChar]">
                                        <option value="auto">Автоопределение</option>
                                        <option value="&quot;">Двойные кавычки (")</option>
                                        <option value="'">Одинарные кавычки (')</option>
                                        <option value="">Без обрамления</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Кодировка</label>
                                    <select class="form-select form-select-sm" name="params[encoding]">
                                        <option value="auto">Автоопределение</option>
                                        <option value="UTF-8">UTF-8</option>
                                        <option value="windows-1251">Windows-1251</option>
                                        <option value="ISO-8859-1">ISO-8859-1</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Общие параметры -->
                        <h6 class="small fw-bold mt-3 mb-2">Общие параметры</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Формат дат</label>
                                <select class="form-select form-select-sm" id="dateFormatSelect" name="params[dateFormat]" onchange="toggleCustomDateFormat()">
                                    <option value="auto">Автоопределение</option>
                                    <option value="dd.MM.yyyy">DD.MM.YYYY (31.12.2023)</option>
                                    <option value="yyyy-MM-dd">YYYY-MM-DD (2023-12-31)</option>
                                    <option value="dd/MM/yyyy">DD/MM/YYYY (31/12/2023)</option>
                                    <option value="dd.MM.yyyy HH:mm:ss">DD.MM.YYYY HH:MM:SS</option>
                                    <option value="custom">Свой формат...</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="customDateFormatContainer" style="display:none;">
                                <label class="form-label small mb-1">Свой формат даты</label>
                                <input type="text" class="form-control form-control-sm" id="customDateFormat" placeholder="yyyy.MM.dd HH:mm:ss">
                                <small class="form-text text-muted">Пример: yyyy.MM.dd HH:mm:ss</small>
                            </div>
                            <!-- Скрытое поле для хранения пользовательского формата -->
                            <input type="hidden" id="actualDateFormat" name="params[dateFormat]" value="auto">
                        </div>

                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Пустые ячейки</label>
                                <select class="form-select form-select-sm" name="params[emptyFieldHandling]">
                                    <option value="empty">Оставлять пустыми</option>
                                    <option value="null">Установить NULL</option>
                                    <option value="default">Значения по умолчанию</option>
                                </select>
                            </div>
                        </div>

                        <!-- Дополнительные флаги -->
                        <div class="mt-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="validateData" name="params[validateData]" value="true" checked>
                                <label class="form-check-label small" for="validateData">Валидировать данные</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="trimWhitespace" name="params[trimWhitespace]" value="true" checked>
                                <label class="form-check-label small" for="trimWhitespace">Удалять пробелы</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="skipEmptyRows" name="params[skipEmptyRows]" value="true" checked>
                                <label class="form-check-label small" for="skipEmptyRows">Пропускать пустые строки</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-link text-muted" onclick="document.getElementById('advancedSettings').classList.toggle('d-none')">
                        <i class="fas fa-cog me-1"></i>Расширенные настройки
                    </button>
                    <button type="submit" id="startImportBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-file-import me-1"></i>Начать импорт
                    </button>
                </div>

                <!-- Прогресс импорта -->
                <div id="importProgress" class="d-none mt-3">
                    <div class="progress mb-2" style="height: 20px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%;">0%</div>
                    </div>
                    <div id="importStatus" class="small text-center">Подготовка к импорту...</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно для создания нового маппинга -->
    <div class="modal fade" id="createMappingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создание сопоставления полей</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createMappingForm">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="mappingName" class="form-label">Название сопоставления</label>
                                <input type="text" class="form-control" id="mappingName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="mappingDescription" class="form-label">Описание</label>
                                <input type="text" class="form-control" id="mappingDescription" name="description">
                            </div>
                        </div>

                        <input type="hidden" name="clientId" th:value="${client.id}">
                        <input type="hidden" name="entityType" id="mappingEntityType" value="product">
                        <input type="hidden" name="composite" id="mappingComposite" value="true">

                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                <tr>
                                    <th>Заголовок в файле</th>
                                    <th>Поле сущности</th>
                                </tr>
                                </thead>
                                <tbody id="mappingTableBody">
                                <!-- Строки будут добавлены динамически -->
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewMapping()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра текущего маппинга -->
    <div class="modal fade" id="viewMappingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Текущее сопоставление полей</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="currentMappingInfo">
                        <p>Название: <span id="currentMappingName">-</span></p>
                        <p>Описание: <span id="currentMappingDescription">-</span></p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                            <tr>
                                <th>Заголовок в файле</th>
                                <th>Поле сущности</th>
                            </tr>
                            </thead>
                            <tbody id="viewMappingTableBody">
                            <!-- Строки будут добавлены динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Глобальные переменные
    let currentEntityType = 'product';
    let isComposite = true;
    let availableMappings = [];
    let currentMapping = null;
    let fieldsMetadata = null;

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        initDragDrop();
        loadAvailableMappings();
        hideAllFileSections();
        // Инициализация скрытых секций
        document.querySelectorAll('.excel-section, .csv-section').forEach(el => {
            el.style.display = 'none';
        });
    });

    // Функция для скрытия всех секций типов файлов
    function hideAllFileSections() {
        document.querySelectorAll('.excel-section, .csv-section').forEach(el => {
            el.style.display = 'none';
        });
    }

    // Валидация формы перед отправкой
    function validateBeforeImport() {
        // Проверка файла
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Пожалуйста, выберите файл для импорта');
            return false;
        }

        // Проверка маппинга
        const mappingSelect = document.getElementById('mappingSelect');
        if (!mappingSelect.value) {
            alert('Необходимо выбрать шаблон сопоставления полей!');
            mappingSelect.classList.add('is-invalid');
            return false;
        }

        // Обрабатываем пользовательский формат даты, если выбран
        handleCustomDateFormat();

        // Добавляем скрытые поля для чекбоксов, которые не отмечены
        document.querySelectorAll('input[type="checkbox"][name^="params"]').forEach(checkbox => {
            if (!checkbox.checked) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = checkbox.name;
                hiddenInput.value = 'false';
                checkbox.parentNode.appendChild(hiddenInput);
            }
        });

        // Показываем прогресс импорта
        document.getElementById('importProgress').classList.remove('d-none');

        // Обновляем прогресс-бар
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '30%';
        progressBar.setAttribute('aria-valuenow', 30);
        progressBar.textContent = '30%';
        document.getElementById('importStatus').textContent = 'Отправка файла...';

        return true;
    }

    // Обработка пользовательского формата даты
    function handleCustomDateFormat() {
        const select = document.getElementById('dateFormatSelect');
        const customFormat = document.getElementById('customDateFormat');
        const actualFormat = document.getElementById('actualDateFormat');

        if (select.value === 'custom' && customFormat.value) {
            actualFormat.value = customFormat.value;
        } else {
            actualFormat.value = select.value;
        }
    }

    // Переключение отображения поля пользовательского формата даты
    function toggleCustomDateFormat() {
        const select = document.getElementById('dateFormatSelect');
        const container = document.getElementById('customDateFormatContainer');
        container.style.display = select.value === 'custom' ? 'block' : 'none';
    }

    // Инициализация drag-and-drop
    function initDragDrop() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragging'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragging'));
        });

        dropArea.addEventListener('drop', e => {
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
    }

    // Обработка выбранного файла
    function handleFile(file) {
        // Показываем превью и получаем тип файла
        document.getElementById('filePreview').style.display = 'block';

        const fileName = file.name;
        const fileType = file.type || getFileExtension(fileName);
        const fileSize = formatFileSize(file.size);

        // Обновляем информацию
        document.getElementById('fileName').textContent = fileName;
        document.getElementById('fileSize').textContent = fileSize;
        document.getElementById('fileType').textContent = fileType;

        // Определяем тип файла для отображения параметров
        const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileType.includes('excel');
        const isCsv = fileName.endsWith('.csv') || fileName.endsWith('.txt') || fileType.includes('csv');

        // Сначала скрываем все секции
        document.querySelectorAll('.excel-section, .csv-section').forEach(el => el.style.display = 'none');

        // Показываем соответствующую секцию
        if (isExcel) document.querySelectorAll('.excel-section').forEach(el => el.style.display = 'block');
        if (isCsv) document.querySelectorAll('.csv-section').forEach(el => el.style.display = 'block');

        // Активируем кнопку импорта если выбран маппинг
        document.getElementById('startImportBtn').disabled = !document.getElementById('mappingSelect').value;

        // Анализируем файл
        analyzeFile(file);
    }

    // Удаление файла
    function removeFile() {
        document.getElementById('fileInput').value = '';
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('startImportBtn').disabled = true;
    }

    // Обновление типа сущности
    function updateEntityType(type) {
        currentEntityType = type;
        document.getElementById('selectedEntityType').value = type;
        document.getElementById('mappingEntityType').value = type;
        loadAvailableMappings();
    }

    // Загрузка доступных маппингов
    function loadAvailableMappings() {
        const clientId = window.location.pathname.split('/')[2];
        fetch(`/api/fields/mappings?clientId=${clientId}&entityType=${currentEntityType}&composite=${isComposite}`)
            .then(response => response.json())
            .then(data => {
                if (data.mappings) {
                    availableMappings = data.mappings;
                    updateMappingSelect();
                }
            })
            .catch(error => console.error('Ошибка загрузки маппингов:', error));
    }

    // Обновление списка маппингов
    function updateMappingSelect() {
        const select = document.getElementById('mappingSelect');
        select.innerHTML = '<option value="">-- Выберите шаблон сопоставления --</option>';

        availableMappings.forEach(mapping => {
            const option = document.createElement('option');
            option.value = mapping.id;
            option.textContent = mapping.name + (mapping.composite ? ' (составной)' : '');
            select.appendChild(option);
        });

        // Обработчик выбора маппинга
        select.onchange = function() {
            // Сбрасываем состояние ошибки
            this.classList.remove('is-invalid');

            // Получаем выбранный маппинг
            const mappingId = this.value;
            currentMapping = mappingId ? availableMappings.find(m => m.id == mappingId) : null;
            document.getElementById('viewMappingBtn').disabled = !currentMapping;

            // Активируем кнопку импорта только если есть файл
            const fileInput = document.getElementById('fileInput');
            const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
            document.getElementById('startImportBtn').disabled = !(hasFile && mappingId);
        };
    }

    // Анализ файла
    function analyzeFile(file) {
        // Очистка таблицы предпросмотра
        const headerRow = document.getElementById('headerRow');
        const previewBody = document.getElementById('previewBody');
        headerRow.innerHTML = '<th class="text-center" colspan="10"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Анализ файла...</th>';
        previewBody.innerHTML = '';

        // Отправка файла для анализа
        const clientId = window.location.pathname.split('/')[2];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('analysisEntityType', currentEntityType);
        formData.append('composite', isComposite);

        fetch(`/clients/${clientId}/import/analyze`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                // Очистка строк таблицы
                headerRow.innerHTML = '';
                previewBody.innerHTML = '';

                // Заполнение заголовков
                if (data.headers && data.headers.length) {
                    data.headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                }

                // Заполнение превью данных
                if (data.sampleData && data.sampleData.length) {
                    data.sampleData.forEach(row => {
                        const tr = document.createElement('tr');
                        if (data.headers && data.headers.length) {
                            data.headers.forEach(header => {
                                const td = document.createElement('td');
                                td.textContent = row[header] || '';
                                tr.appendChild(td);
                            });
                        }
                        previewBody.appendChild(tr);
                    });
                }

                // Сохраняем метаданные
                window.fileHeaders = data.headers || [];
                window.fieldsMetadata = data.fieldsMetadata;
            })
            .catch(error => {
                headerRow.innerHTML = '';
                previewBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Ошибка при анализе файла</td></tr>';
                console.error('Ошибка анализа:', error);
            });
    }

    // Подготовка модального окна для создания маппинга
    function prepareCreateMappingModal() {
        document.getElementById('mappingName').value = '';
        document.getElementById('mappingDescription').value = '';
        document.getElementById('mappingTableBody').innerHTML = '';

        // Проверка наличия заголовков
        const headers = window.fileHeaders || [];
        if (headers.length === 0) {
            document.getElementById('mappingTableBody').innerHTML =
                '<tr><td colspan="2" class="text-center text-warning">Загрузите и проанализируйте файл для автоматического заполнения заголовков</td></tr>';
            new bootstrap.Modal(document.getElementById('createMappingModal')).show();
            return;
        }

        // Отображение строк маппинга для каждого заголовка
        headers.forEach((header, index) => {
            addMappingRow(header);
        });

        new bootstrap.Modal(document.getElementById('createMappingModal')).show();
    }

    // Добавление строки маппинга
    function addMappingRow(headerValue = '') {
        const tableBody = document.getElementById('mappingTableBody');
        const row = document.createElement('tr');

        // Ячейка с заголовком
        const headerCell = document.createElement('td');
        const headerInput = document.createElement('input');
        headerInput.type = 'text';
        headerInput.className = 'form-control form-control-sm';
        headerInput.value = headerValue;
        headerInput.onchange = function() {
            // Обновление name у select при изменении заголовка
            const fieldSelect = row.querySelector('select');
            if (fieldSelect) {
                fieldSelect.name = 'mapping.' + this.value;
            }
        };
        headerCell.appendChild(headerInput);

        // Ячейка с выбором поля
        const fieldCell = document.createElement('td');
        const fieldSelect = document.createElement('select');
        fieldSelect.className = 'form-control form-control-sm';
        fieldSelect.name = 'mapping.' + headerValue;

        // Добавление пустой опции
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Не выбрано --';
        fieldSelect.appendChild(emptyOption);

        // Добавление опций из metadata
        populateFieldOptions(fieldSelect);

        fieldCell.appendChild(fieldSelect);

        row.appendChild(headerCell);
        row.appendChild(fieldCell);
        tableBody.appendChild(row);
    }

    // Заполнение селектора полей
    function populateFieldOptions(fieldSelect) {
        if (!window.fieldsMetadata) return;

        try {
            if (window.fieldsMetadata.entities) {
                window.fieldsMetadata.entities.forEach(entity => {
                    if (entity.fields && entity.fields.length) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = entity.displayName || entity.type;

                        entity.fields.forEach(field => {
                            const option = document.createElement('option');
                            option.value = field.name;
                            option.textContent = field.displayName || field.name;
                            optgroup.appendChild(option);
                        });

                        fieldSelect.appendChild(optgroup);
                    }
                });
            }
        } catch (error) {
            console.error('Ошибка при заполнении полей:', error);
        }
    }

    // Сохранение нового маппинга
    function saveNewMapping() {
        const mappingName = document.getElementById('mappingName').value;
        if (!mappingName) {
            alert('Пожалуйста, введите название сопоставления');
            return;
        }

        const clientId = document.querySelector('input[name="clientId"]').value;
        const entityType = document.getElementById('mappingEntityType').value;
        const isComposite = document.getElementById('mappingComposite').value;
        const description = document.getElementById('mappingDescription').value || '';

        // Создаем FormData
        const formData = new FormData();
        formData.append('name', mappingName);
        formData.append('description', description);
        formData.append('clientId', clientId);
        formData.append('entityType', entityType);
        formData.append('composite', isComposite);

        // Добавляем маппинги полей
        const rows = document.getElementById('mappingTableBody').querySelectorAll('tr');
        let mappingCounter = 0;

        rows.forEach(row => {
            const headerInput = row.querySelector('input[type="text"]');
            const fieldSelect = row.querySelector('select');

            if (headerInput && fieldSelect && headerInput.value && fieldSelect.value) {
                formData.append('mapping.' + headerInput.value, fieldSelect.value);
                mappingCounter++;
            }
        });

        if (mappingCounter === 0) {
            alert('Необходимо выбрать хотя бы одно сопоставление полей');
            return;
        }

        // Добавляем связанные сущности
        if (isComposite === 'true' && entityType === 'product') {
            formData.append('relatedEntities', 'region');
            formData.append('relatedEntities', 'competitor');
        }

        // Отправляем запрос
        fetch('/api/fields/mappings', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                alert('Маппинг успешно создан!');
                bootstrap.Modal.getInstance(document.getElementById('createMappingModal')).hide();
                loadAvailableMappings();
            })
            .catch(error => {
                alert('Ошибка при создании маппинга: ' + error.message);
            });
    }

    // Показ текущего маппинга
    function showCurrentMapping() {
        if (!currentMapping) return;

        document.getElementById('currentMappingName').textContent = currentMapping.name || '-';
        document.getElementById('currentMappingDescription').textContent = currentMapping.description || '-';

        document.getElementById('viewMappingTableBody').innerHTML = `
            <tr>
                <td colspan="2" class="text-center text-info">
                    <i class="fas fa-info-circle me-2"></i>Подробный просмотр деталей маппинга будет доступен в следующих версиях
                </td>
            </tr>
            <tr>
                <td class="fw-bold">ID</td>
                <td>${currentMapping.id}</td>
            </tr>
            <tr>
                <td class="fw-bold">Тип сущности</td>
                <td>${currentMapping.entityType}</td>
            </tr>
            <tr>
                <td class="fw-bold">Составной</td>
                <td>${currentMapping.composite ? 'Да' : 'Нет'}</td>
            </tr>
        `;

        new bootstrap.Modal(document.getElementById('viewMappingModal')).show();
    }

    // Вспомогательные функции
    function formatFileSize(size) {
        if (size < 1024) return size + ' B';
        if (size < 1048576) return (size / 1024).toFixed(1) + ' KB';
        return (size / 1048576).toFixed(1) + ' MB';
    }

    function getFileExtension(filename) {
        return filename.split('.').pop().toLowerCase();
    }
</script>
</body>
</html>