<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/main :: html(
        'Настройка маппинга - ' + ${client.name},
        ~{::section},
        ~{::script},
        ~{::style},
        'Настройка соответствия полей',
        ~{::.page-actions}
      )}">
<head>
    <title>Настройка маппинга</title>
    <style>
        .mapping-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .template-selector {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .mapping-table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .mapping-table th {
            background-color: #007bff;
            color: white;
            font-weight: 500;
        }
        .field-select {
            min-width: 200px;
        }
        .auto-matched {
            background-color: #d4edda;
        }
        .required-field {
            color: #dc3545;
            font-weight: bold;
        }
        .mapping-status {
            font-size: 0.875rem;
        }
        .mapping-status.success {
            color: #28a745;
        }
        .mapping-status.warning {
            color: #ffc107;
        }
        .mapping-status.error {
            color: #dc3545;
        }
        .template-badge {
            font-size: 0.75rem;
            margin-left: 10px;
        }
        .mapping-actions {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 20px 0;
            border-top: 1px solid #dee2e6;
            margin-top: 20px;
        }
        .csv-header {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#saveTemplateModal">
        <i class="fas fa-save me-1"></i>Сохранить шаблон
    </button>
</div>

<section>
    <!-- Информация о процессе -->
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-3 fs-4"></i>
            <div>
                <strong>Шаг 3 из 3:</strong> Настройка соответствия полей CSV и базы данных<br>
                <small>Файл: <span th:text="${fileName}">file.csv</span> |
                    Тип данных: <span th:text="${importDto.entityType}">Product</span> |
                    Колонок: <span th:text="${#lists.size(csvHeaders)}">0</span></small>
            </div>
        </div>
    </div>

    <!-- Выбор шаблона -->
    <div class="template-selector">
        <h5 class="mb-3">
            <i class="fas fa-layer-group me-2"></i>Выбор шаблона маппинга
        </h5>
        <div class="row align-items-center">
            <div class="col-md-8">
                <select class="form-select" id="templateSelect">
                    <option value="auto" selected>Автоматический маппинг (рекомендуется)</option>
                    <option th:each="template : ${templates}"
                            th:value="${template.id}"
                            th:text="${template.name}">Шаблон</option>
                    <option value="new">Создать новый шаблон...</option>
                </select>
            </div>
            <div class="col-md-4">
                <span class="badge bg-success template-badge" id="autoMatchBadge">
                    <i class="fas fa-check me-1"></i>Автоматически сопоставлено:
                    <span th:text="${#lists.size(autoTemplate.rules)}">0</span> полей
                </span>
            </div>
        </div>
    </div>

    <!-- Форма маппинга -->
    <form th:action="@{/clients/{id}/import/start(id=${client.id})}" method="post"
          enctype="multipart/form-data" id="mappingForm">

        <!-- Скрытые поля -->
        <input type="hidden" th:field="${importDto.clientId}">
        <input type="hidden" th:field="${importDto.entityType}">
        <input type="hidden" th:field="${importDto.encoding}">
        <input type="hidden" th:field="${importDto.delimiter}">
        <input type="hidden" th:field="${importDto.quoteChar}">
        <input type="hidden" th:field="${importDto.hasHeader}">
        <input type="hidden" th:field="${importDto.skipEmptyLines}">
        <input type="hidden" th:field="${importDto.trimValues}">
        <input type="hidden" th:field="${importDto.batchSize}">
        <input type="hidden" name="mappingTemplateId" id="mappingTemplateId" value="">

        <!-- Таблица маппинга -->
        <div class="mapping-container">
            <h5 class="mb-3">
                <i class="fas fa-exchange-alt me-2"></i>Соответствие полей
            </h5>

            <div class="mapping-table">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                        <th width="30">#</th>
                        <th>Поле в CSV файле</th>
                        <th>Поле в базе данных</th>
                        <th width="100">Обязательное</th>
                        <th width="150">Статус</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="header, iter : ${csvHeaders}"
                        th:class="${autoTemplate.findRuleByCsvHeader(header) != null ? 'auto-matched' : ''}">
                        <td th:text="${iter.count}">1</td>
                        <td>
                            <span class="csv-header" th:text="${header}">CSV Header</span>
                        </td>
                        <td>
                            <select class="form-select field-select"
                                    th:name="'mapping[' + ${header} + ']'"
                                    th:id="'field_' + ${iter.index}">
                                <option value="">-- Не импортировать --</option>

                                <!-- Поля для Product -->
                                <optgroup th:if="${importDto.entityType == 'Product'}" label="Основные поля товара">
                                    <option value="productId">ID товара</option>
                                    <option value="productName">Название товара</option>
                                    <option value="productBrand">Бренд</option>
                                    <option value="productBar">Штрихкод</option>
                                    <option value="productDescription">Описание</option>
                                    <option value="productUrl">Ссылка</option>
                                    <option value="productCategory1">Категория 1</option>
                                    <option value="productCategory2">Категория 2</option>
                                    <option value="productCategory3">Категория 3</option>
                                    <option value="productPrice">Цена</option>
                                    <option value="productAnalog">Аналог</option>
                                </optgroup>
                                <optgroup th:if="${importDto.entityType == 'Product'}" label="Дополнительные поля товара">
                                    <option value="productAdditional1">Дополнительное поле 1</option>
                                    <option value="productAdditional2">Дополнительное поле 2</option>
                                    <option value="productAdditional3">Дополнительное поле 3</option>
                                    <option value="productAdditional4">Дополнительное поле 4</option>
                                    <option value="productAdditional5">Дополнительное поле 5</option>
                                </optgroup>

                                <!-- Поля для Region -->
                                <optgroup th:if="${importDto.entityType == 'Region'}" label="Поля региона">
                                    <option value="region">Город</option>
                                    <option value="regionAddress">Адрес</option>
                                </optgroup>

                                <!-- Поля для Competitor -->
                                <optgroup th:if="${importDto.entityType == 'Competitor'}" label="Основные поля конкурента">
                                    <option value="competitorName">Название сайта</option>
                                    <option value="competitorPrice">Цена конкурента</option>
                                    <option value="competitorPromotionalPrice">Акционная цена</option>
                                    <option value="competitorTime">Время</option>
                                    <option value="competitorDate">Дата</option>
                                    <option value="competitorStockStatus">Статус наличия</option>
                                    <option value="competitorAdditionalPrice">Дополнительная цена</option>
                                    <option value="competitorCommentary">Комментарий</option>
                                    <option value="competitorProductName">Название товара у конкурента</option>
                                    <option value="competitorUrl">Ссылка на товар</option>
                                    <option value="competitorWebCacheUrl">Ссылка на скриншот</option>
                                </optgroup>
                                <optgroup th:if="${importDto.entityType == 'Competitor'}" label="Дополнительные поля конкурента">
                                    <option value="competitorAdditional">Дополнительное поле</option>
                                    <option value="competitorAdditional2">Дополнительное поле 2</option>
                                </optgroup>

                                <!-- Поля для Combined -->
                                <optgroup th:if="${importDto.entityType == 'Combined'}" label="Поля товара">
                                    <option value="productId">ID товара</option>
                                    <option value="productName">Название товара</option>
                                    <option value="productBrand">Бренд</option>
                                    <option value="productPrice">Цена</option>
                                    <option value="productCategory1">Категория</option>
                                </optgroup>
                                <optgroup th:if="${importDto.entityType == 'Combined'}" label="Поля региона">
                                    <option value="region">Город</option>
                                    <option value="regionAddress">Адрес</option>
                                </optgroup>
                                <optgroup th:if="${importDto.entityType == 'Combined'}" label="Поля конкурента">
                                    <option value="competitorName">Сайт конкурента</option>
                                    <option value="competitorPrice">Цена конкурента</option>
                                    <option value="competitorStockStatus">Статус наличия</option>
                                </optgroup>
                            </select>
                        </td>
                        <td class="text-center">
                                <span class="required-field"
                                      th:if="${autoTemplate.findRuleByCsvHeader(header)?.isRequired}">
                                    <i class="fas fa-asterisk"></i>
                                </span>
                        </td>
                        <td>
                                <span class="mapping-status success"
                                      th:if="${autoTemplate.findRuleByCsvHeader(header) != null}">
                                    <i class="fas fa-check-circle"></i> Сопоставлено
                                </span>
                            <span class="mapping-status warning"
                                  th:unless="${autoTemplate.findRuleByCsvHeader(header) != null}">
                                    <i class="fas fa-exclamation-circle"></i> Не сопоставлено
                                </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Статистика маппинга -->
            <div class="mt-3 text-muted">
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    Сопоставлено полей: <span id="mappedCount">0</span> из <span th:text="${#lists.size(csvHeaders)}">0</span>
                </small>
            </div>
        </div>

        <!-- Предупреждения -->
        <div class="alert alert-warning" id="warningAlert" style="display: none;">
            <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle me-2"></i>Внимание!
            </h6>
            <ul class="mb-0" id="warningList">
            </ul>
        </div>

        <!-- Кнопки действий -->
        <div class="mapping-actions">
            <button type="submit" class="btn btn-success btn-lg" id="startImportBtn">
                <i class="fas fa-upload me-2"></i>Начать импорт
            </button>
            <button type="button" class="btn btn-primary ms-2" id="validateBtn">
                <i class="fas fa-check me-2"></i>Проверить маппинг
            </button>
            <a th:href="@{/clients/{id}/import(id=${client.id})}" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-times me-2"></i>Отмена
            </a>
        </div>
    </form>

    <!-- Модальное окно сохранения шаблона -->
    <div class="modal fade" id="saveTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сохранить шаблон маппинга</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Название шаблона</label>
                        <input type="text" class="form-control" id="templateName"
                               placeholder="Например: Импорт товаров с ценами">
                    </div>
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="templateDescription" rows="3"
                                  placeholder="Опишите назначение шаблона"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="makeDefault">
                        <label class="form-check-label" for="makeDefault">
                            Сделать шаблоном по умолчанию
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="saveTemplateBtn">
                        <i class="fas fa-save me-1"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const templateSelect = document.getElementById('templateSelect');
        const mappingForm = document.getElementById('mappingForm');
        const validateBtn = document.getElementById('validateBtn');
        const startImportBtn = document.getElementById('startImportBtn');
        const warningAlert = document.getElementById('warningAlert');
        const warningList = document.getElementById('warningList');
        const mappedCountSpan = document.getElementById('mappedCount');

        // Обновление счетчика сопоставленных полей
        function updateMappedCount() {
            const selects = document.querySelectorAll('.field-select');
            let count = 0;
            selects.forEach(select => {
                if (select.value) count++;
            });
            mappedCountSpan.textContent = count;
        }

        // Валидация маппинга
        function validateMapping() {
            const warnings = [];
            const selects = document.querySelectorAll('.field-select');
            const usedFields = new Set();
            let hasAnyMapping = false;

            selects.forEach((select, index) => {
                const value = select.value;
                if (value) {
                    hasAnyMapping = true;
                    if (usedFields.has(value)) {
                        warnings.push(`Поле "${value}" используется несколько раз`);
                    }
                    usedFields.add(value);
                }
            });

            if (!hasAnyMapping) {
                warnings.push('Не выбрано ни одно поле для импорта');
            }

            // Проверка обязательных полей для типа сущности
            const entityType = document.querySelector('[name="entityType"]').value;
            if (entityType === 'Product') {
                if (!usedFields.has('productName')) {
                    warnings.push('Не указано обязательное поле "Название товара"');
                }
            }

            // Отображение предупреждений
            if (warnings.length > 0) {
                warningList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
                warningAlert.style.display = 'block';
                return false;
            } else {
                warningAlert.style.display = 'none';
                return true;
            }
        }

        // Обработчики событий
        document.querySelectorAll('.field-select').forEach(select => {
            select.addEventListener('change', updateMappedCount);
        });

        validateBtn.addEventListener('click', function() {
            if (validateMapping()) {
                alert('Маппинг настроен корректно!');
            }
        });

        // Обработка выбора шаблона
        templateSelect.addEventListener('change', function() {
            const value = this.value;

            if (value === 'new') {
                // Открыть модальное окно для создания нового шаблона
                const modal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
                modal.show();
                this.value = 'auto'; // Вернуть на автоматический
            } else if (value !== 'auto') {
                // Загрузить выбранный шаблон
                document.getElementById('mappingTemplateId').value = value;
                // Здесь можно добавить AJAX запрос для загрузки правил шаблона
            } else {
                // Автоматический маппинг
                document.getElementById('mappingTemplateId').value = '';
            }
        });

        // Обработка отправки формы
        mappingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Собираем маппинг
            const mappingData = {};
            document.querySelectorAll('.field-select').forEach((select, index) => {
                const csvHeader = document.querySelectorAll('.csv-header')[index].textContent;
                if (select.value) {
                    mappingData[csvHeader] = select.value;
                }
            });

            // Создаем скрытое поле для передачи маппинга
            const mappingInput = document.createElement('input');
            mappingInput.type = 'hidden';
            mappingInput.name = 'mappingData';
            mappingInput.value = JSON.stringify(mappingData);
            this.appendChild(mappingInput);

            // Проверяем, что хотя бы одно поле замаплено
            if (Object.keys(mappingData).length === 0) {
                alert('Пожалуйста, выберите хотя бы одно поле для импорта');
                this.removeChild(mappingInput);
                return;
            }

            // Проверяем обязательные поля в зависимости от типа
            const entityType = document.querySelector('[name="entityType"]').value;
            let missingRequired = false;

            if (entityType === 'Product' && !Object.values(mappingData).includes('productName')) {
                alert('Для импорта товаров обязательно поле "Название товара"');
                this.removeChild(mappingInput);
                return;
            }

            if (entityType === 'Region' && !Object.values(mappingData).includes('region')) {
                alert('Для импорта регионов обязательно поле "Город"');
                this.removeChild(mappingInput);
                return;
            }

            if (entityType === 'Competitor' && !Object.values(mappingData).includes('competitorName')) {
                alert('Для импорта конкурентов обязательно поле "Название сайта"');
                this.removeChild(mappingInput);
                return;
            }

            // Если всё в порядке, отправляем форму
            startImportBtn.disabled = true;
            startImportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Запуск импорта...';
            this.submit();
        });

        // Сохранение шаблона
        document.getElementById('saveTemplateBtn').addEventListener('click', function() {
            const templateName = document.getElementById('templateName').value;
            const templateDescription = document.getElementById('templateDescription').value;
            const makeDefault = document.getElementById('makeDefault').checked;

            if (!templateName) {
                alert('Пожалуйста, введите название шаблона');
                return;
            }

            // Собрать текущий маппинг
            const mappingRules = [];
            document.querySelectorAll('.field-select').forEach((select, index) => {
                if (select.value) {
                    const csvHeader = document.querySelectorAll('.csv-header')[index].textContent;
                    mappingRules.push({
                        csvHeader: csvHeader,
                        entityField: select.value,
                        orderIndex: index
                    });
                }
            });

            // Отправить на сервер
            const templateData = {
                name: templateName,
                description: templateDescription,
                entityType: document.querySelector('[name="entityType"]').value,
                isDefault: makeDefault,
                rules: mappingRules
            };

            fetch('/clients/' + [[${client.id}]] + '/import/mapping/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(templateData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Шаблон успешно сохранен!');
                        // Закрыть модальное окно
                        bootstrap.Modal.getInstance(document.getElementById('saveTemplateModal')).hide();
                        // Добавить в список шаблонов
                        const option = new Option(templateName, data.templateId);
                        templateSelect.add(option);
                        templateSelect.value = data.templateId;
                        document.getElementById('mappingTemplateId').value = data.templateId;
                    } else {
                        alert('Ошибка сохранения шаблона: ' + (data.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка сохранения шаблона: ' + error.message);
                });
        });

        // Начальное обновление счетчика
        updateMappedCount();
    });
</script>
</body>
</html>