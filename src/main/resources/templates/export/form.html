<!-- src/main/resources/templates/export/form.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/main :: html(
        ~{::title},
        ~{::div.content},
        ~{::script},
        ~{},
        'Экспорт данных',
        ~{::div.page-actions}
      )">
<head>
    <title>Экспорт данных</title>
</head>
<body>
<!-- Действия страницы -->
<div class="page-actions">
    <a th:href="@{/clients/{id}(id=${client.id})}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Назад к клиенту
    </a>
</div>

<!-- Основное содержимое -->
<div class="content">
    <div class="card">
        <div class="card-header">
            <h4>Экспорт данных для клиента: <span th:text="${client != null ? client.name : ''}"></span></h4>
        </div>
        <div class="card-body">
            <!-- Форма выбора типа сущности -->
            <form th:if="${entityTypes != null && (selectedEntityType == null || selectedEntityType.isEmpty())}"
                  th:action="@{${currentUri}}" method="get" class="mb-4">
                <div class="form-group mb-3">
                    <label for="entityType">Выберите тип данных для экспорта:</label>
                    <select id="entityType" name="entityType" class="form-control" required>
                        <option value="" selected disabled>-- Выберите тип данных --</option>
                        <option th:each="entity : ${entityTypes}"
                                th:value="${entity.entityType}"
                                th:text="${entity.displayName}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-arrow-right"></i> Продолжить
                </button>
            </form>

            <!-- Форма экспорта данных -->
            <form th:if="${selectedEntityType != null && !selectedEntityType.isEmpty()}"
                  th:action="@{${currentUri}}" method="post">

                <input type="hidden" name="entityType" th:value="${selectedEntityType}">

                <!-- Выбор формата файла -->
                <div class="form-group mb-3">
                    <label for="format">Формат экспорта:</label>
                    <select id="format" name="format" class="form-control" required>
                        <option value="csv" selected>CSV</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>

                <!-- Базовые параметры формата -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Параметры формата</h5>
                    </div>
                    <div class="card-body">
                        <!-- Общие параметры -->
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="includeHeader"
                                   name="includeHeader" value="true" checked>
                            <label class="form-check-label" for="includeHeader">
                                Включить заголовки колонок
                            </label>
                        </div>

                        <!-- Параметры CSV -->
                        <div id="csvParams">
                            <div class="form-group mb-2">
                                <label for="delimiter">Разделитель:</label>
                                <select id="delimiter" name="delimiter" class="form-control">
                                    <option value="," selected>Запятая (,)</option>
                                    <option value=";">Точка с запятой (;)</option>
                                    <option value="|">Вертикальная черта (|)</option>
                                    <option value="&#09">Табуляция</option>
                                </select>
                            </div>
                            <div class="form-group mb-2">
                                <label for="quoteChar">Символ кавычек:</label>
                                <select id="quoteChar" name="quoteChar" class="form-control">
                                    <option value="&quot;" selected>Двойные кавычки (")</option>
                                    <option value="'">Одинарные кавычки (')</option>
                                </select>
                            </div>
                        </div>

                        <!-- Параметры Excel -->
                        <div id="excelParams" style="display: none;">
                            <div class="form-group mb-2">
                                <label for="sheetName">Имя листа:</label>
                                <input type="text" id="sheetName" name="sheetName"
                                       class="form-control" value="Данные">
                            </div>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="autoSizeColumns"
                                       name="autoSizeColumns" value="true" checked>
                                <label class="form-check-label" for="autoSizeColumns">
                                    Автоматически подгонять ширину колонок
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Выбор полей -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Выберите поля для экспорта</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <button type="button" id="selectAllBtn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-check-square"></i> Выбрать все
                            </button>
                            <button type="button" id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-square"></i> Снять выбор
                            </button>
                        </div>

                        <!-- Поля основной сущности -->
                        <div th:if="${entityFields != null}" class="mt-3">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-table"></i> Основная сущность:
                                <span th:text="${selectedEntityType}">Product</span>
                            </h6>

                            <div class="row">
                                <div th:each="field, stat : ${entityFields}" class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               th:id="${'field_main_' + stat.index}"
                                               name="fields"
                                               th:value="${field.key}">
                                        <label class="form-check-label"
                                               th:for="${'field_main_' + stat.index}"
                                               th:text="${field.value.displayName}"></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Поля связанных сущностей -->
                        <div th:if="${relatedFields != null}" th:each="entityEntry : ${relatedFields}" class="mt-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-link"></i> Связанная сущность:
                                <span th:text="${entityEntry.key}">Related Entity</span>
                            </h6>

                            <div class="row">
                                <div th:each="field, stat : ${entityEntry.value}" class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input"
                                               th:id="${'field_' + entityEntry.key + '_' + stat.index}"
                                               name="fields"
                                               th:value="${field.key}">
                                        <label class="form-check-label"
                                               th:for="${'field_' + entityEntry.key + '_' + stat.index}"
                                               th:text="${field.value.displayName}"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-export"></i> Экспортировать
                    </button>
                    <a th:href="@{/clients/{id}(id=${client != null ? client.id : ''})}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Отмена
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Скрипты страницы -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Переключение параметров формата
        const formatSelect = document.getElementById('format');
        if (formatSelect) {
            formatSelect.addEventListener('change', function() {
                document.getElementById('csvParams').style.display =
                    this.value === 'csv' ? 'block' : 'none';
                document.getElementById('excelParams').style.display =
                    this.value === 'csv' ? 'none' : 'block';
            });
        }

        // Кнопки выбора/снятия выбора полей
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');

        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                document.querySelectorAll('input[name="fields"]').forEach(function(checkbox) {
                    checkbox.checked = true;
                });
            });
        }

        if (deselectAllBtn) {
            deselectAllBtn.addEventListener('click', function() {
                document.querySelectorAll('input[name="fields"]').forEach(function(checkbox) {
                    checkbox.checked = false;
                });
            });
        }
    });
</script>
</body>
</html>